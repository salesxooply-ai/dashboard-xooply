<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Sales (Hibrida)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        /* Menggunakan Inter sebagai font utama, dengan fallback ke font sistem sans-serif */
        body { font-family: 'Inter', sans-serif; }
        
        /* Style untuk tombol filter periode yang aktif */
        .filter-btn.active { background-color: #3b82f6; color: white; }
        
        /* Style untuk tooltip (saat ini tidak digunakan, tapi ada di kode asli) */
        .tooltip { position: relative; display: inline-block; cursor: pointer; }
        .tooltip .tooltiptext { visibility: hidden; width: 220px; background-color: #1f2937; color: #fff; text-align: left; border-radius: 6px; padding: 5px 8px; position: absolute; z-index: 10; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

        /* Custom style untuk status deal (Sekarang hanya label statis) */
        .status-label {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
        }

        /* Warna spesifik untuk setiap status */
        .status-Awareness { background-color: #2563eb22; color: #3b82f6; border: 1px solid #3b82f6; } 
        .status-Interest { background-color: #05966922; color: #10b981; border: 1px solid #10b981; } 
        .status-Desire { background-color: #f59e0b22; color: #f59e0b; border: 1px solid #f59e0b; } 
        .status-ProcessClosing { background-color: #f59e0b22; color: #f59e0b; border: 1px solid #f59e0b; } 
        .status-Action { background-color: #ef444422; color: #ef4444; border: 1px solid #ef4444; } 
        .status-Delivery { background-color: #3b82f622; color: #3b82f6; border: 1px solid #3b82f6; } 
        .status-Payment { background-color: #10b98122; color: #10b981; border: 1px solid #10b981; } 
        .status-Lost { background-color: #7f1d1d22; color: #f87171; border: 1px solid #f87171; } 

        /* Style untuk AIDA progress bar */
        .progress-bar-container {
            display: flex;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            background-color: #374151; /* Darker background for empty space */
        }

        .progress-segment {
            height: 100%;
            transition: width 0.5s ease-out;
            border-right: 1px solid #1f2937; /* Pemisah tipis antar segmen */
        }
        .progress-segment:last-child {
            border-right: none;
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .grid-cols-2-mobile {
                grid-template-columns: 1fr;
            }
        }

        /* --- PERBAIKAN TATA LETAK KALENDER (TINGGI BARU) --- */
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 1px; 
            background-color: #374151; 
            border: 1px solid #374151; 
        }
        .calendar-day-header { 
            font-size: 0.75rem; 
            text-align: center; 
            padding: 8px 0; 
            font-weight: 500; 
            color: #9ca3af; 
            background-color: #374151; 
        }
        .calendar-cell { 
            background-color: #1f293b; 
            padding: 4px; 
            min-height: 95px; /* Disesuaikan agar sejajar dengan 3 grafik di kanan */
            position: relative; 
            display: flex; 
            flex-direction: column;
            overflow: hidden; /* **PENTING**: Mencegah event keluar dari batas sel */
        }
        .calendar-date { 
            font-size: 0.8rem; 
            font-weight: 500; 
            margin-bottom: 4px; 
            color: #d1d5db; 
        }
        /* Style .calendar-event LAMA diganti di bawah */
        .calendar-event { 
            background-color: #3b82f6; 
            border-left: 3px solid #60a5fa; 
            color: white; 
            padding: 1px 4px; /* Padding dikurangi */
            margin-bottom: 2px; 
            border-radius: 2px; 
            font-size: 0.6rem; /* Font size dikurangi */
            cursor: pointer; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
        }
        .today .calendar-date { 
            background-color: #3b82f6; 
            color: white; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            padding: 2px;
        }
        
        /* Style untuk tabel baru */
        #supportTableContainer table {
            width: 100%;
            border-collapse: collapse;
        }
        #supportTableContainer th, #supportTableContainer td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #374151; /* Garis pemisah abu-abu tua */
        }
        #supportTableContainer th {
            background-color: #1f293b; /* Header abu-abu gelap */
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #9ca3af; /* Teks abu-abu terang */
            font-weight: 600;
        }
        #supportTableContainer tr:hover {
            background-color: #2a3447; /* Hover row yang lebih gelap */
        }
        #supportTableContainer td {
            font-size: 0.875rem;
            color: #d1d5db; /* Teks putih keabu-abuan */
        }
         /* Style untuk tombol "+ Lainnya" di kalender */
        .calendar-others {
            font-size: 0.7rem;
            color: #a5f3fc; /* text-cyan-200 */
            text-align: center;
            padding: 1px 4px; /* Padding dikurangi */
            margin-top: 2px;
            border-radius: 2px;
            background-color: #334155; /* bg-slate-700 */
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .calendar-others:hover {
            background-color: #475569; /* bg-slate-600 */
        }

        /* --- FADE-IN BARU UNTUK DASHBOARD (DURASI LEBIH LAMA) --- */
        .fade-in-dashboard {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out; /* Ditingkatkan ke 0.8s */
        }
        .fade-in-dashboard.visible {
            opacity: 1;
            transform: translateY(0);
        }
        /* --- AKHIR FADE-IN BARU --- */

        /* --- STYLE BARU UNTUK TAB --- */
        .tab-button {
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .active-tab {
            color: #3b82f6; /* text-blue-500 */
            border-bottom-color: #3b82f6;
        }
        .inactive-tab {
            color: #9ca3af; /* text-gray-400 */
        }
        .inactive-tab:hover {
            color: #d1d5db; /* text-gray-300 */
            border-bottom-color: #4b5563; /* border-gray-600 */
        }
        
        /* --- STYLE BARU UNTUK EVENT KALENDER --- */
        .calendar-event-realized { 
            background-color: #3b82f6; /* Solid Biru (Realisasi) */
            border-left: 3px solid #60a5fa; 
            color: white; 
            padding: 1px 4px; 
            margin-bottom: 2px; 
            border-radius: 2px; 
            font-size: 0.6rem; 
            cursor: pointer; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
        }
        .calendar-event-planned { 
            background-color: transparent;
            border: 1px dashed #475569; /* Garis putus-putus (Rencana) */
            color: #9ca3af; /* text-gray-400 */
            padding: 1px 4px; 
            margin-bottom: 2px; 
            border-radius: 2px; 
            font-size: 0.6rem; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 sm:p-8">

    <div id="loginScreen" class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-sm fade-in border border-gray-700">
            <div class="text-center mb-6">
                <img src="https://info.xooply.id/wp-content/uploads/2023/01/Xooply-New-Fix.png" alt="Company Logo" class="h-16 w-auto mx-auto mb-4 bg-white p-2 rounded-lg">
                <h1 class="text-2xl font-bold text-white mt-4">Dashboard Monitoring Sales Activity</h1>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="roleSelector" class="block text-sm font-medium text-gray-400 mb-1">Pilih Peran</label>
                    <select id="roleSelector" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="sales">Sales Person</option>
                        <option value="manager">Manager</option>
                        <option value="head_sales">Head Sales</option>
                    </select>
                </div>
                <div id="managerSelectorContainer" class="hidden">
                    <label for="managerSelector" class="block text-sm font-medium text-gray-400 mb-1">Pilih Manager</label>
                    <select id="managerSelector" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                </div>
                <div id="salesPersonSelectorContainer">
                    <label for="salesPersonSelector" class="block text-sm font-medium text-gray-400 mb-1">Pilih Nama Anda</label>
                    <select id="salesPersonSelector" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                </div>
                <div>
                    <label for="passwordInput" class="block text-sm font-medium text-gray-400 mb-1">Password</label>
                    <input type="password" id="passwordInput" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan password Anda">
                </div>
                <button id="loginBtn" class="w-full bg-blue-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-blue-700 transition-colors">Masuk</button>
                <p id="loginError" class="text-red-500 text-sm text-center pt-2 hidden">Password atau username salah.</p>
            </div>
        </div>
    </div>
    <div id="loadingIndicator" class="flex flex-col items-center justify-center min-h-screen p-4 text-center hidden">
        <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-gray-400 mt-3">Sedang mengambil data...</p>
    </div>

    <div id="mainContent" class="hidden container mx-auto p-4 md:p-8 fade-in-dashboard">

        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
            <div>
                 <h1 class="text-3xl font-bold text-white mb-2">Dashboard Sales Activity</h1>
                 <p id="dashboardSubtitle" class="text-gray-400">Analisis Gabungan Kinerja dan Aktivitas Harian.</p> 
            </div>
            <div class="flex items-center gap-4 mt-4 sm:mt-0">
                <button id="logoutBtn" class="flex items-center bg-gray-700 text-gray-300 font-semibold py-2 px-4 rounded-lg shadow-sm border border-gray-600 hover:bg-gray-600 transition-colors">
                    <i data-lucide="log-out" class="mr-2 h-5 w-5"></i>
                    Logout
                </button>
            </div>
        </header>

        <div id="salesTabsContainer" class="mb-6 border-b border-gray-700 hidden">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button id="tab-btn-1" data-tab="1" 
                        class="tab-button active-tab whitespace-nowrap py-3 px-4 text-base font-medium">
                    <i data-lucide="calendar-plus" class="inline-block h-5 w-5 mr-2"></i>
                    1. Perencanaan
                </button>
                <button id="tab-btn-2" data-tab="2" 
                        class="tab-button inactive-tab whitespace-nowrap py-3 px-4 text-base font-medium">
                    <i data-lucide="edit-3" class="inline-block h-5 w-5 mr-2"></i>
                    2. Realisasi
                </button>
                <button id="tab-btn-3" data-tab="3" 
                        class="tab-button inactive-tab whitespace-nowrap py-3 px-4 text-base font-medium">
                    <i data-lucide="layout-dashboard" class="inline-block h-5 w-5 mr-2"></i>
                    3. Dashboard Summary
                </button>
            </nav>
        </div>
        
        <div id="tab-content">
            
            <div id="tab-panel-1" class="tab-panel hidden">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                        <div class="flex justify-between items-start mb-4">
                            <h2 class="text-lg font-semibold text-white">Total Aktivitas Terjadwal</h2>
                            <i data-lucide="calendar-check-2" class="h-6 w-6 text-green-400"></i>
                        </div>
                        <p class="text-5xl font-bold text-white mb-3" id="metricRencanaTotal">0</p>
                        <div class="flex items-center text-sm text-green-400">
                            <i data-lucide="check-circle-2" class="h-4 w-4 mr-2"></i>
                            <span id="metricRencanaSelesai" class="font-medium mr-1">0</span> Selesai
                        </div>
                        <div class="flex items-center text-sm text-yellow-400 mt-1">
                            <i data-lucide="clock" class="h-4 w-4 mr-2"></i>
                            <span id="metricRencanaMenunggu" class="font-medium mr-1">0</span> Menunggu
                        </div>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                        <div class="flex justify-between items-start mb-4">
                            <h2 class="text-lg font-semibold text-white">Rata-rata Realisasi Harian</h2>
                            <i data-lucide="map-pin" class="h-6 w-6 text-blue-400"></i>
                        </div>
                        <p class="text-5xl font-bold text-white mb-3" id="metricAvgRealisasi">0.0</p>
                        <p class="text-sm text-gray-400">Target Harian: <span id="metricTargetHarian">8</span> Aktivitas</p>
                        <div id="metricSelisihWrapper">
                            <p class="text-base font-medium text-red-400 mt-1" id="metricSelisihHarian">Perlu +8.0 Aktivitas/Hari</p>
                        </div>
                    </div>

                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4 text-white">Buat Rencana Aktivitas</h2>
                        <div id="planSuccessMessage" class="hidden bg-emerald-900 text-emerald-300 p-3 rounded-lg mb-4 text-sm border border-emerald-700"></div>
                        <form id="planForm">
                        <div class="mb-4">
                            <label for="planDate" class="block text-sm font-medium text-gray-400">Tgl Rencana</label>
                            <input type="date" id="planDate" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" style="color-scheme: dark;" required>
                        </div>

                        <div class="mb-4">
                            <label for="planClientName" class="block text-sm font-medium text-gray-400">Nama Klien</label>
                            <input type="text" id="planClientName" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" list="clientList" required>
                            <datalist id="clientList">
                                </datalist>
                        </div>

                        <div class="mb-4">
                            <label for="planActivityType" class="block text-sm font-medium text-gray-400">Tipe Aktivitas</label>
                            <select id="planActivityType" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" required>
                                <option value="Online Meeting">Online Meeting</option>
                                <option value="Kunjungan">Kunjungan</option>
                                <option value="Telepon">Telepon</option>
                                <option value="Follow Up Email">Follow Up Email</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="planObjective" class="block text-sm font-medium text-gray-400">Tujuan Meeting</label>
                            <select id="planObjective" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" required>
                                <option value="Perkenalan dan mencari Leads">Perkenalan dan mencari Leads</option>
                                <option value="Follow up inisiasi atau Leads">Follow up inisiasi atau Leads</option>
                            </select>
                        </div>

                        <div id="planFollowUpContainer" class="mb-4 hidden">
                            <label for="planFollowUpLead" class="block text-sm font-medium text-gray-400">Pilih Inisiasi / Lead</label>
                            <select id="planFollowUpLead" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg">
                                <option value="">-- Memuat data --</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="planNotes" class="block text-sm font-medium text-gray-400">Objektif / Catatan</label>
                            <textarea id="planNotes" rows="3" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg"></textarea>
                        </div>

                        <button type="submit" id="savePlanBtn" class="w-full bg-blue-600 text-white font-semibold py-2.5 px-4 rounded-lg flex items-center justify-center hover:bg-blue-700 transition-colors">
                            <i data-lucide="plus" class="h-5 w-5 mr-2"></i> Tambah ke Rencana
                        </button>
                    </form>
                    </div>

                    <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                        <h2 class="text-xl font-semibold mb-4 text-white">Daftar Rencana Aktivitas (Belum Realisasi)</h2>
                        <div id="planListContainer" class="space-y-3 max-h-[500px] overflow-y-auto">
                            <p id="noPlansText" class="text-gray-500">Belum ada rencana yang dibuat.</p>
                        </div>
                    </div>
                </div>

            </div>

            <div id="tab-panel-2" class="tab-panel hidden">
                
                <div class="bg-gray-700 p-4 rounded-lg mb-6 border border-gray-600">
                    <label for="planSelector" class="block text-sm font-medium text-gray-300 mb-2">
                        <i data-lucide="check-square" class="inline-block h-5 w-5 mr-1 text-green-400"></i>
                        <strong>Pilih Rencana yang Direalisasi</strong> <span class="text-red-400">*</span>
                </label>
                <p class="text-xs text-gray-400 mb-2">Pilih rencana untuk mengisi form di bawah ini secara otomatis.</p>
                    <select id="planSelector" class="w-full mt-1 px-3 py-2 border border-gray-500 bg-gray-600 text-white rounded-lg" required>
                        <option value="">-- Tidak, ini aktivitas baru --</option>
                        </select>
                </div>

                <div id="inputFormContainer" class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8 border border-gray-700">
                     <h2 class="text-xl font-semibold mb-4 text-white">Tambah Aktivitas Baru</h2>
                     <div id="successMessage" class="hidden bg-emerald-900 text-emerald-300 p-3 rounded-lg mb-4 text-sm border border-emerald-700"></div>
                     <div id="errorMessage" class="hidden bg-red-900 text-red-300 p-3 rounded-lg mb-4 text-sm border border-red-700"></div>
                    <form id="activityForm">
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div><label for="clientName" class="block text-sm font-medium text-gray-400">Nama Klien</label><input type="text" id="clientName" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" required></div>
                            <div><label for="meetingDate" class="block text-sm font-medium text-gray-400">Tgl Meeting</label><input type="date" id="meetingDate" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" style="color-scheme: dark;" required></div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="lokasiProvinsi" class="block text-sm font-medium text-gray-400">Provinsi</label>
                                <select id="lokasiProvinsi" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" required>
                                    <option value="">-- Pilih Provinsi --</option>
                                    </select>
                            </div>
                            <div>
                                <label for="lokasiKota" class="block text-sm font-medium text-gray-400">Kota/Kabupaten</label>
                                <select id="lokasiKota" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" required>
                                    <option value="">-- Pilih Provinsi Dulu --</option>
                                    </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="clientSegment" class="block text-sm font-medium text-gray-400">Segmen Klien</label>
                                <select id="clientSegment" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" required>
                                    <option value="Enterprise">Enterprise</option>
                                    <option value="Government">Government</option>
                                    <option value="Education">Education</option>
                                </select>
                            </div>
                            <div>
                                <label for="salesPerson" class="block text-sm font-medium text-gray-400">Nama Sales</label>
                                <select id="salesPerson" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-600 text-white rounded-lg" required disabled></select>
                            </div>
                         </div>
                         <div class="mb-4">
                             <label class="block text-sm font-medium mb-2 text-gray-400">Tipe Klien</label>
                             <div class="flex gap-4"><label class="flex items-center"><input type="radio" name="clientType" value="new" class="h-4 w-4 text-blue-500" checked><span class="ml-2">Klien Baru</span></label><label class="flex items-center"><input type="radio" name="clientType" value="existing" class="h-4 w-4 text-blue-500"><span class="ml-2">Klien Existing</span></label></div>
                        </div>
                         
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            
                            <div>
                                <label for="nomorRFQ" class="block text-sm font-medium text-gray-400">Lead ID (Opsional)</label>
                                <input type="text" id="nomorRFQ" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg">
                            </div>
                            
                            <div>
                                <label for="namaProject" class="block text-sm font-medium text-gray-400">Nama Project</label>
                                <input type="text" id="namaProject" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" required>
                            </div>
                        </div>

                         <div class="mb-4"><label for="meetingNotes" class="block text-sm font-medium text-gray-400">Hasil Meeting</label><textarea id="meetingNotes" rows="3" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg"></textarea></div>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label for="meetingType" class="block text-sm font-medium text-gray-400">Type Aktivitas</label>
                                <select id="meetingType" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" required>
                                    <option>Awareness</option><option>Interest</option><option>Desire</option><option>Process Closing</option><option>Action</option><option>Delivery</option><option>Payment</option><option>Lost</option>
                                </select>
                            </div>
                            <div>
                                <label for="capability" class="block text-sm font-medium text-gray-400">Capability</label>
                                <select id="capability" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" required>
                                    <option>SIPLah</option>
                                    <option>IT Outsourcing</option>
                                </select>
                            </div>
                            <div>
                                <label for="dealValue" class="block text-sm font-medium text-gray-400">Estimasi Amount (Rp)</label>
                                <input type="text" id="dealValue" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg" oninput="formatRupiah(this)" required>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="unitInCharge" class="block text-sm font-medium text-gray-400">Unit in Charge (Support)</label>
                                <select id="unitInCharge" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg">
                                    </select>
                            </div>
                            <div>
                                <label for="supportCategory" class="block text-sm font-medium text-gray-400">Kategori Support</label>
                                <select id="supportCategory" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg">
                                    </select>
                            </div>
                        </div>

                        <div id="recurringOption" class="mb-4 hidden"><label class="flex items-center"><input type="checkbox" id="isRecurring" class="h-4 w-4 text-blue-500"><span class="ml-2">Pelanggan recurring</span></label></div>
                        <div id="obstacleSection" class="mb-6 hidden"><label for="salesObstacle" class="block text-sm font-medium text-gray-400">Hambatan</label><select id="salesObstacle" class="w-full mt-1 px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg"><option>Harga Terlalu Tinggi</option><option>Kalah dari Kompetitor</option><option>Fitur Produk Kurang</option><option>Waktu Tidak Tepat</option><option>Lainnya</option></select></div>
                        <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white font-semibold py-2.5 px-4 rounded-lg flex items-center justify-center hover:bg-blue-700 transition-colors">Simpan</button>
                    </form>
                </div>
                </div>

            <div id="tab-panel-3" class="tab-panel">
                
                <div class="bg-gray-800 p-6 rounded-xl shadow-sm mb-8 border border-gray-700">
                    <h2 class="text-xl font-semibold mb-4 text-white">Filter Global</h2>
                    <div class="flex flex-col sm:flex-row gap-4 items-center">
                        
                        <div id="managerFilterContainer" class="w-full sm:w-auto hidden">
                            <label for="salesFilter" class="block text-sm font-medium text-gray-400 mb-1 sr-only">Filter Sales</label>
                            <select id="salesFilter" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                         </div>
                        
                        <div id="globalPeriodFilters" class="flex items-center bg-gray-700 rounded-lg p-1 text-sm shrink-0">
                            <button class="filter-btn px-3 py-1 rounded-md transition-colors text-gray-300 hover:bg-gray-600" data-period="this-week">Minggu Ini</button>
                            <button class="filter-btn px-3 py-1 rounded-md transition-colors text-gray-300 hover:bg-gray-600 active" data-period="this-month">Bulan Ini</button>
                            <button class="filter-btn px-3 py-1 rounded-md transition-colors text-gray-300 hover:bg-gray-600" data-period="custom">Custom</button>
                        </div>
                        
                        <div id="customDateContainer" class="hidden sm:flex items-center gap-2 text-sm">
                            <input type="date" id="startDate" class="px-2 py-1 border border-gray-600 bg-gray-700 text-white rounded-md" style="color-scheme: dark;">
                            <span class="text-gray-400">-</span>
                            <input type="date" id="endDate" class="px-2 py-1 border border-gray-600 bg-gray-700 text-white rounded-md" style="color-scheme: dark;">
                        </div>
                    </div>

        <div id="managerTabsContainer" class="mb-6 border-b border-gray-700">
    <nav class="flex space-x-4" aria-label="Tabs">
        <button id="manager-tab-btn-1" data-manager-tab="1" 
                class="manager-tab-button tab-button active-tab whitespace-nowrap py-3 px-4 text-base font-medium">
            <i data-lucide="bar-chart-3" class="inline-block h-5 w-5 mr-2"></i>
            Dashboard Utama & KPI
        </button>
        <button id="manager-tab-btn-2" data-manager-tab="2" 
                class="manager-tab-button tab-button inactive-tab whitespace-nowrap py-3 px-4 text-base font-medium">
            <i data-lucide="calendar-search" class="inline-block h-5 w-5 mr-2"></i>
            Analisis Aktivitas & Support
        </button>
        <button id="manager-tab-btn-3" data-manager-tab="3" 
                class="manager-tab-button tab-button inactive-tab whitespace-nowrap py-3 px-4 text-base font-medium">
            <i data-lucide="list-filter" class="inline-block h-5 w-5 mr-2"></i>
            Leads of Project Aktif
        </button>
        <button id="manager-tab-btn-4" data-manager-tab="4" 
                class="manager-tab-button tab-button inactive-tab whitespace-nowrap py-3 px-4 text-base font-medium hidden">
            <i data-lucide="layout-grid" class="inline-block h-5 w-5 mr-2"></i>
            Performance (Looker)
        </button>
    </nav>
</div>
                <div id="manager-tab-content">
                    
                    <div id="manager-tab-panel-1" class="manager-tab-panel space-y-8">
                        
                        <div id="summaryContainer" class="mt-8 hidden">
                            <div id="summaryText" class="bg-gray-800 p-6 rounded-xl shadow-lg text-gray-300 border border-gray-700">
                            </div>
                        </div>
<div id="managerPlanningMetricsWrapper" class="hidden">
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">

    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
        <div class="flex justify-between items-start mb-4">
            <h2 class="text-lg font-semibold text-white">Total Aktivitas Terjadwal</h2>
            <i data-lucide="calendar-check-2" class="h-6 w-6 text-green-400"></i>
        </div>
        <p class="text-5xl font-bold text-white mb-3" id="mgr-metricRencanaTotal">0</p>
        <div class="flex items-center text-sm text-green-400">
            <i data-lucide="check-circle-2" class="h-4 w-4 mr-2"></i>
            <span id="mgr-metricRencanaSelesai" class="font-medium mr-1">0</span> Selesai
        </div>
        <div class="flex items-center text-sm text-yellow-400 mt-1">
            <i data-lucide="clock" class="h-4 w-4 mr-2"></i>
            <span id="mgr-metricRencanaMenunggu" class="font-medium mr-1">0</span> Menunggu
        </div>
    </div>

    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
        <div class="flex justify-between items-start mb-4">
            <h2 class="text-lg font-semibold text-white">Rata-rata Realisasi Harian</h2>
            <i data-lucide="map-pin" class="h-6 w-6 text-blue-400"></i>
        </div>
        <p class="text-5xl font-bold text-white mb-3" id="mgr-metricAvgRealisasi">0.0</p>
        <p class="text-sm text-gray-400">Target Harian: <span id="mgr-metricTargetHarian">8</span> Aktivitas</p>
        <div id="metricSelisihWrapper">
            <p class="text-base font-medium text-red-400 mt-1" id="mgr-metricSelisihHarian">Perlu +8.0 Aktivitas/Hari</p>
        </div>
    </div>

</div>
</div>

                        <div id="metricsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700">
                                <p class="text-sm font-medium text-gray-400 flex items-center">Total Meeting <i data-lucide="calendar" class="w-4 h-4 ml-1 text-blue-400"></i></p>
                                <p id="metricTotalMeetings" class="text-3xl font-bold text-white mt-1">0</p>
                            </div>
                            <div class="bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700">
                                <p class="text-sm font-medium text-gray-400 flex items-center">Total Klien Baru <i data-lucide="user-plus" class="w-4 h-4 ml-1 text-red-400"></i></p>
                                <p id="metricNewClients" class="text-3xl font-bold text-white mt-1">0</p>
                            </div>
                            <div class="bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700">
                                <p class="text-sm font-medium text-gray-400 flex items-center">Total Klien Existing <i data-lucide="users" class="w-4 h-4 ml-1 text-yellow-400"></i></p>
                                <p id="metricExistingClients" class="text-3xl font-bold text-white mt-1">0</p>
                            </div>
                            <div class="bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700">
                                <p class="text-sm font-medium text-gray-400 flex items-center">Total Lead ID Unik <i data-lucide="folder-open" class="w-4 h-4 ml-1 text-purple-400"></i></p>
                                <p id="metricTotalRFQs" class="text-3xl font-bold text-white mt-1">0</p>
                            </div>
                        </div>


                        <div class="flex flex-col lg:flex-row gap-6">
                            
                            <div class="lg:w-2/3 space-y-6">
                                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                                    <h2 class="text-xl font-semibold text-white mb-4 flex items-center">Distribusi Aktivitas Pipeline (AIDA)</h2>
                                    <div id="aidaProgressBar" class="progress-bar-container"></div>
                                    <div class="flex justify-between text-sm text-gray-400 mt-2">
                                        <span class="text-blue-400">Awareness</span>
                                        <span class="text-green-400">Interest</span>
                                        <span class="text-yellow-400">Desire</span>
                                        <span class="text-red-400">Action</span> 
                                    </div>
                                    <div id="aidaLegend" class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-4 text-sm"></div>
                                </div>
                                
                                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                                    <h2 class="text-xl font-semibold text-white mb-4 flex items-center">Distribusi Segmen Klien</h2>
                                    <div id="clientSegmentProgressBar" class="progress-bar-container"></div>
                                    <div class="flex justify-between text-sm text-gray-400 mt-2">
                                        <span class="text-purple-400">Enterprise</span>
                                        <span class="text-orange-400">Government</span>
                                        <span class="text-cyan-400">Education</span> 
                                    </div>
                                    <div id="clientSegmentLegend" class="mt-4 grid grid-cols-3 gap-4 text-sm"></div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700 flex flex-col justify-center">
                                        <h2 class="text-sm font-semibold text-gray-400 mb-1">Rata-rata Durasi Sales Cycle</h2>
                                        <div class="flex items-end mt-1">
                                            <p id="avgSalesCycleDuration" class="text-3xl font-bold text-purple-400">0</p>
                                            <p class="text-lg text-gray-400 ml-2">hari</p>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">(Awareness ke Action)</p>
                                    </div>
                                    <div class="bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700">
                                        <p class="text-sm font-medium text-gray-400">Avg. Pergerakan Tahap</p>
                                        <p id="metricAvgSteps" class="text-3xl font-bold text-white mt-1">0</p>
                                        <p class="text-xs text-gray-500 mt-1">Meeting / Lead ID Won</p>
                                    </div>
                                    <div class="bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700">
                                        <p class="text-sm font-medium text-gray-400">Rasio Lead ID Existing</p>
                                        <p id="metricExistingRatio" class="text-3xl font-bold text-white mt-1">0%</p>
                                        <p class="text-xs text-gray-500 mt-1">Indikator Engagement</p>
                                    </div>
                                </div>
<div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 overflow-x-auto">
                <h2 class="text-xl font-semibold text-white mb-4">Lead ID Tanpa Follow-Up ( > 7 Hari)</h2>
                <div class="min-w-full">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead>
                            <tr>
                                <th class="whitespace-nowrap px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Nama Klien</th>
                                <th class="whitespace-nowrap px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Nama Project</th>
                                <th class="whitespace-nowrap px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Estimasi Amount</th>
                                <th class="whitespace-nowrap px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status Terakhir</th>
                                <th class="whitespace-nowrap px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Tanpa Aktivitas (Hari)</th>
                            </tr>
                        </thead>
                        <tbody id="staleLeadsTableBody" class="divide-y divide-gray-700">
                            <tr><td colspan="5" class="text-center text-gray-500 py-4">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

                            </div>
				
          
                            <div class="lg:w-1/3 space-y-6">
                                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                                    <h2 class="text-xl font-semibold mb-4 text-white">Type Aktivitas</h2>
                                    <div class="h-64 relative">
                                        <canvas id="topMeetingTypesChart"></canvas> 
                                    </div>
                                </div>
                                
                                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                                    <h2 class="text-xl font-semibold mb-4 text-white">Fokus Capability</h2>
                                    <div class="h-64 relative">
                                        <canvas id="capabilityChart"></canvas>
                                    </div>
                                </div>
                                 <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                                    <h2 class="text-xl font-semibold mb-4 text-white">Win Rate (per Lead ID)</h2>
                                    <div class="h-64 relative">
                                        <canvas id="winRateChart"></canvas> 
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                        
                    </div>
                    
                    <div id="manager-tab-panel-2" class="manager-tab-panel hidden space-y-6">
                        
                        <div id="dailyActivityTrendContainer" class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 hidden">
                            <div class="flex justify-between items-center mb-1">
                                <h2 class="text-xl font-semibold text-white">Tren Fokus Aktivitas Harian</h2>
                                 <div id="trendIndicator" class="flex items-center text-sm font-semibold"></div>
                            </div>
                             <p class="text-xs text-gray-500 mb-4">Perbandingan dengan periode sebelumnya</p>
                            <div class="h-96">
                                <canvas id="dailyActivityChart"></canvas>
                            </div>
                        </div>

                        <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold text-white">Kalender Aktivitas</h2>
                                <div class="flex items-center gap-2">
                                    <button id="prevMonthBtn" class="p-1 rounded-md hover:bg-gray-700 text-gray-400"><i data-lucide="chevron-left" class="h-5 w-5"></i></button>
                                    <span id="currentMonthYear" class="font-semibold w-24 text-center text-white text-sm"></span>
                                    <button id="nextMonthBtn" class="p-1 rounded-md hover:bg-gray-700 text-gray-400"><i data-lucide="chevron-right" class="h-5 w-5"></i></button>
                                </div>
                            </div>
                            <div id="calendarContainer">
                                <div class="calendar-grid">
                                    <div class="calendar-day-header">Sen</div>
                                    <div class="calendar-day-header">Sel</div>
                                    <div class="calendar-day-header">Rab</div>
                                    <div class="calendar-day-header">Kam</div>
                                    <div class="calendar-day-header">Jum</div>
                                    <div class="calendar-day-header">Sab</div>
                                    <div class="calendar-day-header">Min</div>
                                    </div>
                            </div>
                        </div>
                        
                       <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 overflow-x-auto">
                        <h2 class="text-xl font-semibold text-white mb-4">Analisa Support Needed (Non-Closed Deals)</h2>
                        <div id="supportTableContainer" class="min-w-full">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead>
                                    <tr>
                                        <th class="whitespace-nowrap">Client</th>
                                        <th class="whitespace-nowrap">Project</th>
                                        <th class="whitespace-nowrap">Est. Amount</th>
                                        <th class="whitespace-nowrap">Support Unit</th>
                                        <th class="whitespace-nowrap">Kategori Support</th>
                                        <th class="whitespace-nowrap">Status Support</th>
                                    </tr>
                                </thead>
                                <tbody id="supportTableBody">
                                    <tr><td colspan="6" class="text-center text-gray-500 py-4">Memuat data support...</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div id="supportPaginationContainer" class="flex justify-between items-center mt-4">
                        </div>
                    </div>

                </div>
<div id="manager-tab-panel-3" class="manager-tab-panel hidden space-y-6">
    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 overflow-x-auto">
        
        <h2 id="activeLeadsTableTitle" ...>...</h2>
        
        </div>
</div> <div id="manager-tab-panel-4" class="manager-tab-panel hidden space-y-6">
    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
        <h2 class="text-xl font-semibold text-white mb-4">
            Dashboard Performa Looker Studio
        </h2>

        <iframe 
            width="100%" 
            height="700" 
            src="https://lookerstudio.google.com/embed/reporting/233db3d6-2ba2-4535-9650-febb4ef65735/page/0F8IF" 
            frameborder="0" 
            style="border:0" 
            allowfullscreen 
            sandbox="allow-storage-access-by-user-activation allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox">
        </iframe>
    </div>
</div>
        
        <div class="mb-6 border-b border-gray-700">
            <nav id="leadsStatusTabsContainer" class="flex space-x-4" aria-label="Tabs">
                <button data-status="Awareness" class="leads-status-tab tab-button active-tab whitespace-nowrap py-3 px-2 text-sm font-medium">
                    Awareness
                </button>
                <button data-status="Interest" class="leads-status-tab tab-button inactive-tab whitespace-nowrap py-3 px-2 text-sm font-medium">
                    Interest
                </button>
                <button data-status="Desire" class="leads-status-tab tab-button inactive-tab whitespace-nowrap py-3 px-2 text-sm font-medium">
                    Desire/Process
                </button>
                <button data-status="Action" class="leads-status-tab tab-button inactive-tab whitespace-nowrap py-3 px-2 text-sm font-medium">
                    Action/Delivery/Payment
                </button>
            </nav>
        </div>

        <h2 id="activeLeadsTableTitle" class="text-xl font-semibold text-white mb-4">Daftar Leads: Awareness</h2>
        
        <div class="min-w-full">
            <table class="min-w-full divide-y divide-gray-700">
                <thead>
                    <tr>
                        <th class="whitespace-nowrap px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Nama Sales</th>
                        <th class="whitespace-nowrap px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Nama Klien</th>
                        <th class="whitespace-nowrap px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Segmen</th>
                        <th class="whitespace-nowrap px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Nama Project</th>
                        <th class="whitespace-nowrap px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status Terakhir</th>
                        <th class="whitespace-nowrap px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Estimasi Amount</th>
                    </tr>
                </thead>
                <tbody id="activeLeadsTableBody" class="divide-y divide-gray-700">
                    </tbody>
            </table>
        </div>

        <div id="activeLeadsPaginationContainer" class="flex justify-between items-center mt-4">
            </div>

    </div>
</div>

    </div>
    <div id="customModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
    <div class="bg-gray-800 p-6 rounded-lg shadow-2xl max-w-sm w-full border border-gray-700">
        <h3 id="modalTitle" class="text-lg font-semibold text-white mb-3">Notifikasi</h3>
        <p id="modalMessage" class="text-gray-300 mb-4"></p>
        <div class="flex justify-end space-x-2">
            <!-- (PERBAIKAN) Tombol Batal, untuk konfirmasi -->
            <button id="modalCancelButton" class="hidden bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150">Batal</button>
            <button id="modalCloseButton" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150">Tutup</button>
        </div>
    </div>
</div>

<div id="calendarModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-lg w-full border border-gray-700 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 id="calendarModalTitle" class="text-xl font-bold text-white">Detail Aktivitas Tanggal</h3>
            <button id="calendarModalCloseButton" class="text-gray-400 hover:text-white p-1 rounded-full">
                <i data-lucide="x" class="h-6 w-6"></i>
            </button>
        </div>
        <div id="calendarModalContent" class="space-y-4">
            </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- KONFIGURASI APLIKASI ---
    // URL Web App Google Apps Script Anda (URL yang Anda berikan setelah redeploy)
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby-V0N4dumud7oeN69oDOeD7uOp54iUMtgiLowYCFaKEI4R0_M95PRhWj1jnzxLBC92/exec';
    const USE_MOCK_DATA = false; // Diatur ke FALSE, sekarang menggunakan Apps Script
    
    // --- STRUKTUR TIM & USER (Diambil dari Dasboard 28 oct 25.txt) ---
    const managers = ['Toni Ardiyanto', 'Andhika Adhigunanto'];
    const teamToni = ['Aldi Apriliano', 'Ardi Ardiansyah', 'Fitri Alifia', 'Wiwin Winarti', 'Sari Widiastuti', 'Syafitri Handayani']; 
    const teamAndhika = ['Mayumi', 'Tomi Dwi Jans', 'Siti Maryam'];
    const allSales = [...teamToni, ...teamAndhika];
    
    const managerTeamMap = {
        'Toni Ardiyanto': teamToni,
        'Andhika Adhigunanto': teamAndhika
    };

    const userCredentials = { 
        'head_sales': 'Xooplyer25',
        'Toni Ardiyanto': 'Toni123!',
        'Andhika Adhigunanto': 'Andhika123!',
        'Aldi Apriliano': 'aldi123!',
        'Ardi Ardiansyah': 'ardi123!',
        'Fitri Alifia': 'fitri123!', 
        'Wiwin Winarti': 'wiwin123!',
        'Sari Widiastuti': 'sari123!',
        'Syafitri Handayani': 'syafitri123!',
        'Mayumi': 'mayumi123!',
        'Tomi Dwi Jans': 'tomi123!',
        'Siti Maryam': 'siti123!'
    };
    // --- AKHIR STRUKTUR TIM ---

    // --- STATE GLOBAL ---
    // --- KONFIGURASI BARU UNTUK RENCANA ---
    let allPlans = []; // Ini HANYA akan menyimpan rencana 'planned'
let allPlansFull = []; // Ini akan menyimpan SEMUA rencana (termasuk 'realized')

    let allDeals = []; 
    let filteredDeals = []; 
    let currentRole = null;
    let currentUser = null;
    let dailyActivityChartInstance = null;
    let currentCalendarDate = new Date(); 
    let charts = {}; 
    let lastDealId = 1000; // Untuk auto-ID jika diperlukan di mock

    // --- State Baru untuk Paginasi Support ---
    let supportCurrentPage = 1;
    const SUPPORT_ROWS_PER_PAGE = 5;
    let currentSupportDeals = []; // Menyimpan daftar yang sudah difilter
    
    // (BARU) State untuk tab Leads Aktif & Paginasi
    let currentActiveLeadStatusTab = 'Awareness'; // Tab default
    let activeLeadsCurrentPage = 1;
    const ACTIVE_LEADS_PER_PAGE = 10;
const AIDA_PIPELINE_ORDER = [
    'Awareness', 
    'Interest', 
    'Desire', 
    'Process Closing', 
    'Action', 
    'Delivery', 
    'Payment', 
    'Lost'
];

    // (PERBAIKAN) State untuk modal konfirmasi
    let modalConfirmCallback = null; 

    // --- DATA WILAYAH INDONESIA (BARU) ---
    const allWilayah = {
        "Aceh": ["Kab. Aceh Selatan", "Kab. Aceh Tenggara", "Kab. Aceh Timur", "Kab. Aceh Tengah", "Kab. Aceh Barat", "Kab. Aceh Besar", "Kab. Pidie", "Kab. Aceh Utara", "Kab. Simeulue", "Kab. Aceh Singkil", "Kab. Bireuen", "Kab. Aceh Barat Daya", "Kab. Gayo Lues", "Kab. Aceh Jaya", "Kab. Nagan Raya", "Kab. Aceh Tamiang", "Kab. Bener Meriah", "Kab. Pidie Jaya", "Kota Banda Aceh", "Kota Sabang", "Kota Lhokseumawe", "Kota Langsa", "Kota Subulussalam"],
        "Sumatera Utara": ["Kab. Tapanuli Tengah", "Kab. Tapanuli Utara", "Kab. Tapanuli Selatan", "Kab. Nias", "Kab. Langkat", "Kab. Karo", "Kab. Deli Serdang", "Kab. Simalungun", "Kab. Asahan", "Kab. Labuhanbatu", "Kab. Dairi", "Kab. Toba Samosir", "Kab. Mandailing Natal", "Kab. Nias Selatan", "Kab. Pakpak Bharat", "Kab. Humbang Hasundutan", "Kab. Samosir", "Kab. Serdang Bedagai", "Kab. Batubara", "Kab. Padang Lawas Utara", "Kab. Padang Lawas", "Kab. Labuhanbatu Selatan", "Kab. Labuhanbatu Utara", "Kab. Nias Utara", "Kab. Nias Barat", "Kota Medan", "Kota Pematangsiantar", "Kota Sibolga", "Kota Tanjung Balai", "Kota Binjai", "Kota Tebing Tinggi", "Kota Padangsidimpuan", "Kota Gunungsitoli"],
        "Sumatera Barat": ["Kab. Pesisir Selatan", "Kab. Solok", "Kab. Sijunjung", "Kab. Tanah Datar", "Kab. Padang Pariaman", "Kab. Agam", "Kab. Lima Puluh Kota", "Kab. Pasaman", "Kab. Kepulauan Mentawai", "Kab. Dharmasraya", "Kab. Solok Selatan", "Kab. Pasaman Barat", "Kota Padang", "Kota Solok", "Kota Sawahlunto", "Kota Padang Panjang", "Kota Bukittinggi", "Kota Payakuh", "Kota Pariaman"],
        "Riau": ["Kab. Kampar", "Kab. Indragiri Hulu", "Kab. Bengkalis", "Kab. Indragiri Hilir", "Kab. Pelalawan", "Kab. Rokan Hulu", "Kab. Rokan Hilir", "Kab. Siak", "Kab. Kuantan Singingi", "Kab. Kepulauan Meranti", "Kota Pekanbaru", "Kota Dumai"],
        "Jambi": ["Kab. Kerinci", "Kab. Merangin", "Kab. Sarolangun", "Kab. Batanghari", "Kab. Muaro Jambi", "Kab. Tanjung Jabung Barat", "Kab. Tanjung Jabung Timur", "Kab. Bungo", "Kab. Tebo", "Kota Jambi", "Kota Sungai Penuh"],
        "Sumatera Selatan": ["Kab. Ogan Komering Ulu", "Kab. Ogan Komering Ilir", "Kab. Muara Enim", "Kab. Lahat", "Kab. Musi Rawas", "Kab. Musi Banyuasin", "Kab. Banyuasin", "Kab. Ogan Komering Ulu Timur", "Kab. Ogan Komering Ulu Selatan", "Kab. Ogan Ilir", "Kab. Empat Lawang", "Kab. Penukal Abab Lematang Ilir", "Kab. Musi Rawas Utara", "Kota Palembang", "Kota Pagar Alam", "Kota Lubuk Linggau", "Kota Prabumulih"],
        "Bengkulu": ["Kab. Bengkulu Selatan", "Kab. Rejang Lebong", "Kab. Bengkulu Utara", "Kab. Kaur", "Kab. Seluma", "Kab. Muko Muko", "Kab. Lebong", "Kab. Kepahiang", "Kab. Bengkulu Tengah", "Kota Bengkulu"],
        "Lampung": ["Kab. Lampung Selatan", "Kab. Lampung Tengah", "Kab. Lampung Utara", "Kab. Lampung Barat", "Kab. Tulang Bawang", "Kab. Tanggamus", "Kab. Lampung Timur", "Kab. Way Kanan", "Kab. Pesawaran", "Kab. Pringsewu", "Kab. Mesuji", "Kab. Tulang Bawang Barat", "Kab. Pesisir Barat", "Kota Bandar Lampung", "Kota Metro"],
        "Kep. Bangka Belitung": ["Kab. Bangka", "Kab. Belitung", "Kab. Bangka Selatan", "Kab. Bangka Tengah", "Kab. Bangka Barat", "Kab. Belitung Timur", "Kota Pangkal Pinang"],
        "Kep. Riau": ["Kab. Bintan", "Kab. Karimun", "Kab. Natuna", "Kab. Lingga", "Kab. Kepulauan Anambas", "Kota Batam", "Kota Tanjung Pinang"],
        "DKI Jakarta": ["Kab. Kepulauan Seribu", "Kota Jakarta Pusat", "Kota Jakarta Utara", "Kota Jakarta Barat", "Kota Jakarta Selatan", "Kota Jakarta Timur"],
        "Jawa Barat": ["Kab. Bogor", "Kab. Sukabumi", "Kab. Cianjur", "Kab. Bandung", "Kab. Garut", "Kab. Tasikmalaya", "Kab. Ciamis", "Kab. Kuningan", "Kab. Cirebon", "Kab. Majalengka", "Kab. Sumedang", "Kab. Indramayu", "Kab. Subang", "Kab. Purwakarta", "Kab. Karawang", "Kab. Bekasi", "Kab. Bandung Barat", "Kab. Pangandaran", "Kota Bogor", "Kota Sukabumi", "Kota Bandung", "Kota Cirebon", "Kota Bekasi", "Kota Depok", "Kota Cimahi", "Kota Tasikmalaya", "Kota Banjar"],
        "Jawa Tengah": ["Kab. Cilacap", "Kab. Banyumas", "Kab. Purbalingga", "Kab. Banjarnegara", "Kab. Kebumen", "Kab. Purworejo", "Kab. Wonosobo", "Kab. Magelang", "Kab. Boyolali", "Kab. Klaten", "Kab. Sukoharjo", "Kab. Wonogiri", "Kab. Karanganyar", "Kab. Sragen", "Kab. Grobogan", "Kab. Blora", "Kab. Rembang", "Kab. Pati", "Kab. Kudus", "Kab. Jepara", "Kab. Demak", "Kab. Semarang", "Kab. Temanggung", "Kab. Kendal", "Kab. Batang", "Kab. Pekalongan", "Kab. Pemalang", "Kab. Tegal", "Kab. Brebes", "Kota Magelang", "Kota Surakarta", "Kota Salatiga", "Kota Semarang", "Kota Pekalongan", "Kota Tegal"],
        "DI Yogyakarta": ["Kab. Kulon Progo", "Kab. Bantul", "Kab. Gunung Kidul", "Kab. Sleman", "Kota Yogyakarta"],
        "Jawa Timur": ["Kab. Pacitan", "Kab. Ponorogo", "Kab. Trenggalek", "Kab. Tulungagung", "Kab. Blitar", "Kab. Kediri", "Kab. Malang", "Kab. Lumajang", "Kab. Jember", "Kab. Banyuwangi", "Kab. Bondowoso", "Kab. Situbondo", "Kab. Probolinggo", "Kab. Pasuruan", "Kab. Sidoarjo", "Kab. Mojokerto", "Kab. Jombang", "Kab. Nganjuk", "Kab. Madiun", "Kab. Magetan", "Kab. Ngawi", "Kab. Bojonegoro", "Kab. Tuban", "Kab. Lamongan", "Kab. Gresik", "Kab. Bangkalan", "Kab. Sampang", "Kab. Pamekasan", "Kab. Sumenep", "Kota Kediri", "Kota Blitar", "Kota Malang", "Kota Probolinggo", "Kota Pasuruan", "Kota Mojokerto", "Kota Madiun", "Kota Surabaya", "Kota Batu"],
        "Banten": ["Kab. Pandeglang", "Kab. Lebak", "Kab. Tangerang", "Kab. Serang", "Kota Tangerang", "Kota Cilegon", "Kota Serang", "Kota Tangerang Selatan"],
        "Bali": ["Kab. Jembrana", "Kab. Tabanan", "Kab. Badung", "Kab. Gianyar", "Kab. Klungkung", "Kab. Bangli", "Kab. Karangasem", "Kab. Buleleng", "Kota Denpasar"],
        "Nusa Tenggara Barat": ["Kab. Lombok Barat", "Kab. Lombok Tengah", "Kab. Lombok Timur", "Kab. Sumbawa", "Kab. Dompu", "Kab. Bima", "Kab. Sumbawa Barat", "Kab. Lombok Utara", "Kota Mataram", "Kota Bima"],
        "Nusa Tenggara Timur": ["Kab. Kupang", "Kab. Timor Tengah Selatan", "Kab. Timor Tengah Utara", "Kab. Belu", "Kab. Alor", "Kab. Flores Timur", "Kab. Sikka", "Kab. Ende", "Kab. Ngada", "Kab. Manggarai", "Kab. Sumba Timur", "Kab. Sumba Barat", "Kab. Lembata", "Kab. Rote Ndao", "Kab. Manggarai Barat", "Kab. Nagekeo", "Kab. Sumba Tengah", "Kab. Sumba Barat Daya", "Kab. Manggarai Timur", "Kab. Sabu Raijua", "Kab. Malaka", "Kota Kupang"],
        "Kalimantan Barat": ["Kab. Sambas", "Kab. Mempawah", "Kab. Sanggau", "Kab. Ketapang", "Kab. Sintang", "Kab. Kapuas Hulu", "Kab. Bengkayang", "Kab. Landak", "Kab. Sekadau", "Kab. Melawi", "Kab. Kayong Utara", "Kab. Kubu Raya", "Kota Pontianak", "Kota Singkawang"],
        "Kalimantan Tengah": ["Kab. Kotawaringin Barat", "Kab. Kotawaringin Timur", "Kab. Kapuas", "Kab. Barito Selatan", "Kab. Barito Utara", "Kab. Katingan", "Kab. Seruyan", "Kab. Sukamara", "Kab. Lamandau", "Kab. Gunung Mas", "Kab. Pulang Pisau", "Kab. Murung Raya", "Kab. Barito Timur", "Kota Palangka Raya"],
        "Kalimantan Selatan": ["Kab. Tanah Laut", "Kab. Kotobaru", "Kab. Banjar", "Kab. Barito Kuala", "Kab. Tapin", "Kab. Hulu Sungai Selatan", "Kab. Hulu Sungai Tengah", "Kab. Hulu Sungai Utara", "Kab. Tabalong", "Kab. Tanah Bumbu", "Kab. Balangan", "Kota Banjarmasin", "Kota Banjarbaru"],
        "Kalimantan Timur": ["Kab. Paser", "Kab. Kutai Kartanegara", "Kab. Berau", "Kab. Kutai Barat", "Kab. Kutai Timur", "Kab. Penajam Paser Utara", "Kab. Mahakam Ulu", "Kota Balikpapan", "Kota Samarinda", "Kota Bontang"],
        "Kalimantan Utara": ["Kab. Bulungan", "Kab. Malinau", "Kab. Nunukan", "Kab. Tana Tidung", "Kota Tarakan"],
        "Sulawesi Utara": ["Kab. Bolaang Mongondow", "Kab. Minahasa", "Kab. Kepulauan Sangihe", "Kab. Kepulauan Talaud", "Kab. Minahasa Selatan", "Kab. Minahasa Utara", "Kab. Minahasa Tenggara", "Kab. Bolaang Mongondow Utara", "Kab. Kepulauan Siau Tagulandang Biaro", "Kab. Bolaang Mongondow Timur", "Kab. Bolaang Mongondow Selatan", "Kota Manado", "Kota Bitung", "Kota Tomohon", "Kota Kotamobagu"],
        "Sulawesi Tengah": ["Kab. Banggai", "Kab. Poso", "Kab. Donggala", "Kab. Toli Toli", "Kab. Buol", "Kab. Morowali", "Kab. Banggai Kepulauan", "Kab. Parigi Moutong", "Kab. Tojo Una Una", "Kab. Sigi", "Kab. Banggai Laut", "Kab. Morowali Utara", "Kota Palu"],
        "Sulawesi Selatan": ["Kab. Kepulauan Selayar", "Kab. Bulukumba", "Kab. Bantaeng", "Kab. Jeneponto", "Kab. Takalar", "Kab. Gowa", "Kab. Sinjai", "Kab. Bone", "Kab. Maros", "Kab. Pangkajene Kepulauan", "Kab. Barru", "Kab. Soppeng", "Kab. Wajo", "Kab. Sidenreng Rappang", "Kab. Pinrang", "Kab. Enrekang", "Kab. Luwu", "Kab. Tana Toraja", "Kab. Luwu Utara", "Kab. Luwu Timur", "Kab. Toraja Utara", "Kota Makassar", "Kota Pare Pare", "Kota Palopo"],
        "Sulawesi Tenggara": ["Kab. Kolaka", "Kab. Konawe", "Kab. Muna", "Kab. Buton", "Kab. Konawe Selatan", "Kab. Bombana", "Kab. Wakatobi", "Kab. Kolaka Utara", "Kab. Konawe Utara", "Kab. Buton Utara", "Kab. Kolaka Timur", "Kab. Konawe Kepulauan", "Kab. Muna Barat", "Kab. Buton Tengah", "Kab. Buton Selatan", "Kota Kendari", "Kota Bau Bau"],
        "Gorontalo": ["Kab. Gorontalo", "Kab. Boalemo", "Kab. Bone Bolango", "Kab. Pahuwato", "Kab. Gorontalo Utara", "Kota Gorontalo"],
        "Sulawesi Barat": ["Kab. Mamuju", "Kab. Pasangkayu", "Kab. Polewali Mandar", "Kab. Mamasa", "Kab. Mamuju Tengah"],
        "Maluku": ["Kab. Maluku Tengah", "Kab. Maluku Tenggara", "Kab. Kepulauan Tanimbar", "Kab. Buru", "Kab. Seram Bagian Timur", "Kab. Seram Bagian Barat", "Kab. Kepulauan Aru", "Kab. Maluku Barat Daya", "Kab. Buru Selatan", "Kota Ambon", "Kota Tual"],
        "Maluku Utara": ["Kab. Halmahera Barat", "Kab. Halmahera Tengah", "Kab. Halmahera Utara", "Kab. Halmahera Selatan", "Kab. Kepulauan Sula", "Kab. Halmahera Timur", "Kab. Pulau Morotai", "Kab. Pulau Taliabu", "Kota Ternate", "Kota Tidore Kepulauan"],
        "Papua": ["Kab. Merauke", "Kab. Jayawijaya", "Kab. Jayapura", "Kab. Nabire", "Kab. Kepulauan Yapen", "Kab. Biak Numfor", "Kab. Puncak Jaya", "Kab. Paniai", "Kab. Mimika", "Kab. Sarmi", "Kab. Keerom", "Kab. Waropen", "Kab. Mamberamo Raya", "Kab. Supiori", "Kab. Asmat", "Kab. Mappi", "Kab. Boven Digoel", "Kab. Yahukimo", "Kab. Pegunungan Bintang", "Kab. Tolikara", "Kab. Lanny Jaya", "Kab. Mamberamo Tengah", "Kab. Yalimo", "Kab. Nduga", "Kab. Puncak", "Kab. Dogiyai", "Kab. Intan Jaya", "Kab. Deiyai", "Kota Jayapura"],
        "Papua Barat": ["Kab. Sorong", "Kab. Manokwari", "Kab. Fak Fak", "Kab. Kaimana", "Kab. Teluk Bintuni", "Kab. Teluk Wondama", "Kab. Sorong Selatan", "Kab. Raja Ampat", "Kab. Tambrauw", "Kab. Maybrat", "Kab. Manokwari Selatan", "Kab. Pegunungan Arfak", "Kota Sorong"],
        "Papua Selatan": ["Kab. Merauke", "Kab. Mappi", "Kab. Asmat", "Kab. Boven Digoel"],
        "Papua Tengah": ["Kab. Nabire", "Kab. Puncak Jaya", "Kab. Paniai", "Kab. Mimika", "Kab. Puncak", "Kab. Dogiyai", "Kab. Intan Jaya", "Kab. Deiyai"],
        "Papua Pegunungan": ["Kab. Jayawijaya", "Kab. Pegunungan Bintang", "Kab. Yahukimo", "Kab. Tolikara", "Kab. Mamberamo Tengah", "Kab. Yalimo", "Kab. Lanny Jaya", "Kab. Nduga"],
        "Papua Barat Daya": ["Kab. Sorong", "Kab. Sorong Selatan", "Kab. Raja Ampat", "Kab. Tambrauw", "Kab. Maybrat", "Kota Sorong"],
    };
    // --- AKHIR DATA WILAYAH ---

    // Struktur Data untuk Support
    const supportCategories = {
        'Tidak perlu support': ['N/A'],
        'Legal & Risk': ['Review Document Kontrak', 'AKC', 'AKP'],
        'Solution & Delivery': ['Sizing project', 'Presales', 'Update Delivery'],
        'PMO': ['Proses Invoicing dan penagihan'],
        'Sales support': ['AM PDD', 'Sirkulir Doc kontrak']
    };
    
    // --- PERBAIKAN: Deklarasi const dipisah ---
    const loginScreen = document.getElementById('loginScreen');
    const mainContent = document.getElementById('mainContent');
    const roleSelector = document.getElementById('roleSelector');
    const salesPersonSelectorContainer = document.getElementById('salesPersonSelectorContainer');
    const salesPersonSelector = document.getElementById('salesPersonSelector');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');
    const loginError = document.getElementById('loginError');
    const logoutBtn = document.getElementById('logoutBtn');
    const dashboardSubtitle = document.getElementById('dashboardSubtitle');

    const globalPeriodFilters = document.getElementById('globalPeriodFilters');
    const customDateContainer = document.getElementById('customDateContainer');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const managerFilterContainer = document.getElementById('managerFilterContainer');
    const salesFilter = document.getElementById('salesFilter');

    const managerSelectorContainer = document.getElementById('managerSelectorContainer');
    const managerSelector = document.getElementById('managerSelector');
    const currentMonthYearEl = document.getElementById('currentMonthYear');

    const inputFormContainer = document.getElementById('inputFormContainer');
    const activityForm = document.getElementById('activityForm');
    const meetingTypeSelect = document.getElementById('meetingType');
    const obstacleSection = document.getElementById('obstacleSection');
    const recurringOption = document.getElementById('recurringOption');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const salesPersonInput = document.getElementById('salesPerson');
    const submitBtn = document.getElementById('submitBtn');

    const summaryContainer = document.getElementById('summaryContainer');
    const summaryTextEl = document.getElementById('summaryText');
    const calendarContainer = document.getElementById('calendarContainer');
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    const trendIndicator = document.getElementById('trendIndicator');
    const dailyActivityTrendContainer = document.getElementById('dailyActivityTrendContainer');
    
    // Metrik Hibrida
    const metricTotalMeetingsEl = document.getElementById('metricTotalMeetings');
    const metricNewClientsEl = document.getElementById('metricNewClients');
    const metricExistingClientsEl = document.getElementById('metricExistingClients');
    const metricTotalRFQsEl = document.getElementById('metricTotalRFQs');
    
    const avgSalesCycleDurationEl = document.getElementById('avgSalesCycleDuration');
    const metricAvgStepsEl = document.getElementById('metricAvgSteps');
    const metricExistingRatioEl = document.getElementById('metricExistingRatio');
    // --- AKHIR PERBAIKAN ---
    // Modal Hibrida
    const calendarModal = document.getElementById('calendarModal'), calendarModalContent = document.getElementById('calendarModalContent'), calendarModalCloseButton = document.getElementById('calendarModalCloseButton');
    // Form Input
    const unitInChargeSelect = document.getElementById('unitInCharge');
    const supportCategorySelect = document.getElementById('supportCategory');
    const lokasiProvinsiSelect = document.getElementById('lokasiProvinsi');
    const lokasiKotaSelect = document.getElementById('lokasiKota');
    const clientSegmentSelect = document.getElementById('clientSegment'); // NEW

    // --- DOM ELEMENTS BARU ---
    const salesTabsContainer = document.getElementById('salesTabsContainer');
    const tabButtons = document.querySelectorAll('#salesTabsContainer .tab-button');
    const tabPanels = document.querySelectorAll('.tab-panel');
    const planForm = document.getElementById('planForm');
    const planSuccessMessage = document.getElementById('planSuccessMessage');
    const planListContainer = document.getElementById('planListContainer');
    const noPlansText = document.getElementById('noPlansText');
    const planSelector = document.getElementById('planSelector'); // Dropdown di Tab 2


    // --- FUNGSI BARU: Logika Tab Switching ---
    function setupTabListeners() {
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;

                // Update Tombol
                tabButtons.forEach(btn => {
                    btn.classList.remove('active-tab');
                    btn.classList.add('inactive-tab');
                });
                button.classList.add('active-tab');
                button.classList.remove('inactive-tab');

                // Update Panel
                tabPanels.forEach(panel => {
                    if (panel.id === `tab-panel-${tabId}`) {
                        panel.classList.remove('hidden');
                    } else {
                        panel.classList.add('hidden');
                    }
                });
                
                // Refresh ikon lucide
                // Panggil lucide.createIcons() TANPA argumen
                // agar ia me-refresh SEMUA ikon di tab yang baru aktif.
                lucide.createIcons();
                
                // Jika pindah ke tab 3 (Dashboard), render ulang chart & kalender
                if(tabId === '3') {
                    renderFilteredDashboard(); 
                }
            });
        });
    }
// --- FUNGSI BARU: Logika Tab Switching (Khusus Manager) ---
function setupManagerTabListeners() {
    const managerTabButtons = document.querySelectorAll('.manager-tab-button');
    const managerTabPanels = document.querySelectorAll('.manager-tab-panel');

    managerTabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.dataset.managerTab;

            // Update Tombol
            managerTabButtons.forEach(btn => {
                btn.classList.remove('active-tab');
                btn.classList.add('inactive-tab');
            });
            button.classList.add('active-tab');
            button.classList.remove('inactive-tab');

            // Update Panel
            managerTabPanels.forEach(panel => {
                if (panel.id === `manager-tab-panel-${tabId}`) {
                    panel.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden');
                }
            });

           // (PERBAIKAN) Hanya render ulang jika tab BUKAN Looker
            if (tabId !== '4') {
                // PENTING: Render ulang dashboard untuk menggambar chart di panel yang baru aktif
                renderFilteredDashboard(); 
            }

            // Refresh ikon lucide
            lucide.createIcons();
        });
    });
}
    // --- FUNGSI BARU: Manajemen Rencana (Planning) ---
    
    // (Helper) Generate ID unik untuk Rencana

    // (Renderer) Tampilkan daftar rencana di Tab 1
    function renderPlanList() {
        if (!planListContainer) return; // Guard clause jika elemen tidak ada
        if (allPlans.length === 0) {
            planListContainer.innerHTML = '';
            noPlansText.classList.remove('hidden');
            return;
        }
        
        noPlansText.classList.add('hidden');
        planListContainer.innerHTML = allPlans
            .sort((a,b) => new Date(a.plan_date) - new Date(b.plan_date)) // Urutkan berdasarkan tanggal
            .map(plan => `
            <div class="bg-gray-700 p-3 rounded-lg flex items-center justify-between">
                <div>
                    <p class="font-semibold text-white">${plan.clientName}</p>
                    <p class="text-sm text-gray-300">${plan.activityType} pada ${plan.plan_date}</p>
                    <p class="text-xs text-gray-400 mt-1">${plan.notes || 'Tidak ada catatan.'}</p>
                </div>
                <button title="Hapus Rencana" class="delete-plan-btn text-red-400 hover:text-red-300 p-2" data-plan-id="${plan.plan_id}">
                    <i data-lucide="trash-2" class="h-5 w-5"></i>
                </button>
            </div>
        `).join('');
        
        lucide.createIcons();
    }

    // (Renderer) Tampilkan opsi rencana di dropdown Tab 2
    function renderPlanSelector() {
        if (!planSelector) return; // Guard clause
        if (allPlans.length === 0) {
            planSelector.innerHTML = '<option value="">-- Tidak ada rencana --</option>';
            return;
        }

        planSelector.innerHTML = '<option value="">-- Pilih Rencana Aktif --</option>' +
            allPlans
            .sort((a,b) => new Date(a.plan_date) - new Date(b.plan_date))
            .map(plan => `
                <option value="${plan.plan_id}">
                    ${plan.plan_date} - ${plan.clientName} (${plan.activityType})
                </option>
            `).join('');
    }

// (BARU) Renderer untuk dropdown Follow Up di Tab 1
    // (MODIFIKASI) Renderer untuk dropdown Follow Up, sekarang dinamis
function renderFollowUpLeadSelector(clientNameFilter = '') {
    const selectEl = document.getElementById('planFollowUpLead');
    if (!selectEl) return;

    // Jika tidak ada nama klien, tampilkan pesan prompt dan nonaktifkan
    if (!clientNameFilter || clientNameFilter.trim() === '') {
        selectEl.innerHTML = '<option value="">-- Ketik Nama Klien Dulu --</option>';
        selectEl.disabled = true; // Nonaktifkan dropdown
        return;
    }

    selectEl.disabled = false; // Aktifkan dropdown
    let optionsHTML = `<option value="">-- Pilih Lead untuk "${clientNameFilter}" --</option>`;
    let planOptionsFound = 0;
    let dealOptionsFound = 0;

    // 1. Ambil dari Rencana Aktif (allPlans) DAN FILTER berdasarkan Nama Klien
    const filteredPlans = allPlans.filter(plan => 
        plan.clientName.toLowerCase() === clientNameFilter.toLowerCase()
    );

    let planOptions = filteredPlans.map(plan => {
        planOptionsFound++;
        return `<option value="plan_${plan.id}">[Rencana] ${plan.clientName} (${plan.activityType})</option>`
    }).join('');

    if (planOptions) {
        optionsHTML += `<optgroup label="Rencana Aktif">${planOptions}</optgroup>`;
    }

    // 2. Ambil dari Lead Terealisasi (allDeals) DAN FILTER berdasarkan Nama Klien
    const latestDealsMap = new Map();
    allDeals
        .filter(deal => deal.client.toLowerCase() === clientNameFilter.toLowerCase()) // <-- FILTER DI SINI
        .forEach(deal => {
            const key = deal.projectGUID || deal.id; // Gunakan GUID
            const dealDate = deal.meetingDateObj?.getTime();
            if (dealDate && (!latestDealsMap.has(key) || dealDate > (latestDealsMap.get(key).meetingDateObj?.getTime() || 0))) {
                latestDealsMap.set(key, deal);
            }
        });

    let dealOptions = Array.from(latestDealsMap.values())
        .sort((a,b) => b.meetingDateObj?.getTime() - a.meetingDateObj?.getTime())
        .map(deal => {
            dealOptionsFound++;
            return `<option value="deal_${deal.projectGUID || deal.id}">[Lead] ${deal.namaProject || deal.client} (${deal.client})</option>`
        }).join('');

    if (dealOptions) {
        optionsHTML += `<optgroup label="Lead Terealisasi">${dealOptions}</optgroup>`;
    }

    // Jika tidak ada data ditemukan untuk klien itu
    if (planOptionsFound === 0 && dealOptionsFound === 0) {
        optionsHTML = `<option value="">-- Tidak ada history untuk "${clientNameFilter}" --</option>`;
    }

    selectEl.innerHTML = optionsHTML;
}
// (BARU) Mengisi datalist untuk autocomplete Nama Klien
function populateClientDatalist() {
    const datalistEl = document.getElementById('clientList');
    if (!datalistEl) return;

    // 1. Ambil nama klien dari data Realisasi (allDeals)
    const dealClients = allDeals.map(deal => deal.client);

    // 2. Ambil nama klien dari data Rencana (menggunakan fungsi yang sudah ada)
    const planClients = allPlansFull.map(plan => plan.clientName);

    // 3. Gabungkan, saring unik, dan filter nama kosong
    const allClientNames = [...new Set([...dealClients, ...planClients])];

    const validClientNames = allClientNames
        .filter(name => name && name.trim() !== '') // Filter nama kosong
        .sort(); // Urutkan A-Z

    // 4. Buat HTML <option>
    datalistEl.innerHTML = validClientNames
        .map(clientName => `<option value="${clientName}"></option>`)
        .join('');
}
    // --- UTILITY FUNCTIONS ---

    // Format mata uang IDR
    const formatIDR = (number) => {
        if (number === null || number === undefined || isNaN(number)) return 'Rp 0';
        return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        }).format(number);
    };

    // Format tanggal ke YYYY-MM-DD
    const formatDate = (dateString) => {
        if (!dateString) return '';
        const date = new Date(dateString);
        date.setHours(12, 0, 0, 0); 
        return date.toISOString().split('T')[0];
    };
    
    // (PERBAIKAN) Modifikasi fungsi modal untuk mendukung Notifikasi
    const showCustomModal = (title, message) => {
        const modal = document.getElementById('customModal');
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMessage').textContent = message;

        // Reset tombol ke default (Notifikasi)
        document.getElementById('modalCloseButton').textContent = 'Tutup';
        document.getElementById('modalCancelButton').classList.add('hidden');
        modalConfirmCallback = null; // Hapus callback lama

        modal.classList.remove('hidden');
        modal.classList.add('flex');
    };
    
    // (PERBAIKAN) Fungsi BARU untuk modal konfirmasi
    const showCustomConfirmModal = (title, message, onConfirm) => {
        const modal = document.getElementById('customModal');
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMessage').textContent = message;

        // Ubah tombol menjadi (Ya/Batal)
        document.getElementById('modalCloseButton').textContent = 'Ya, Lanjutkan';
        document.getElementById('modalCancelButton').classList.remove('hidden');
        modalConfirmCallback = onConfirm; // Simpan callback

        modal.classList.remove('hidden');
        modal.classList.add('flex');
    };
    
    // (PERBAIKAN) Event listener untuk tombol modal utama (Tutup / Ya)
    document.getElementById('modalCloseButton').addEventListener('click', () => {
        if (modalConfirmCallback) {
            // Jika ini adalah modal konfirmasi, panggil callback
            modalConfirmCallback();
            modalConfirmCallback = null; // Hapus setelah dipanggil
        }
        // Selalu tutup modal
        const modal = document.getElementById('customModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    });

    // (PERBAIKAN) Event listener BARU untuk tombol Batal
    document.getElementById('modalCancelButton').addEventListener('click', () => {
        modalConfirmCallback = null; // Hapus callback
        const modal = document.getElementById('customModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    });

    // Format input (Estimasi Amount) menjadi format ribuan saat diketik
    function formatRupiah(input) {
        // Ambil nilai tanpa titik
        let value = input.value.replace(/\./g, '');

        // Hanya izinkan angka
        value = value.replace(/[^0-9]/g, '');

        // Format kembali dengan titik sebagai pemisah ribuan
        const formattedValue = value.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        input.value = formattedValue;
    }
    
    // Ekspos fungsi formatRupiah ke global scope agar dapat dipanggil dari HTML oninput
    window.formatRupiah = formatRupiah;

    // Fungsi untuk mengisi dropdown (Pilihan Sales, Manager)
    function populateDropdowns() {
        salesPersonSelector.innerHTML = allSales.map(name => `<option value="${name}">${name}</option>`).join('');
        managerSelector.innerHTML = managers.map(name => `<option value="${name}">${name}</option>`).join('');
        salesPersonInput.innerHTML = allSales.map(name => `<option value="${name}">${name}</option>`).join('');
    }

    // Fungsi untuk mengisi dropdown support (Unit & Kategori)
    function populateSupportDropdowns() {
        // 1. Isi Unit in Charge
        unitInChargeSelect.innerHTML = Object.keys(supportCategories)
            .map(unit => `<option value="${unit}">${unit}</option>`)
            .join('');
        
        // 2. Fungsi untuk update Kategori
        function updateSupportCategories() {
            const selectedUnit = unitInChargeSelect.value;
            const categories = supportCategories[selectedUnit] || [];
            supportCategorySelect.innerHTML = categories
                .map(category => `<option value="${category}">${category}</option>`)
                .join('');
        }

        // 3. Tambahkan listener ke Unit
        unitInChargeSelect.addEventListener('change', updateSupportCategories);
        
        // 4. Panggil sekali
        updateSupportCategories();
    }
    
    // FUNGSI BARU UNTUK LOKASI
    function populateWilayahDropdowns() {
        // 1. Isi Provinsi
        const provinsiOptions = Object.keys(allWilayah).sort().map(prov => 
            `<option value="${prov}">${prov}</option>`
        ).join('');
        lokasiProvinsiSelect.innerHTML = '<option value="">-- Pilih Provinsi --</option>' + provinsiOptions;

        // 2. Tambahkan listener ke Provinsi
        lokasiProvinsiSelect.addEventListener('change', () => {
            const selectedProv = lokasiProvinsiSelect.value;
            lokasiKotaSelect.innerHTML = ''; 
            
            if (selectedProv && allWilayah[selectedProv]) {
                const kotaOptions = allWilayah[selectedProv].sort().map(kota =>
                    `<option value="${kota}">${kota}</option>`
                ).join('');
                lokasiKotaSelect.innerHTML = '<option value="">-- Pilih Kota/Kabupaten --</option>' + kotaOptions;
            } else {
                lokasiKotaSelect.innerHTML = '<option value="">-- Pilih Provinsi Dulu --</option>';
            }
        });
    }

// ... (setelah fungsi populateWilayahDropdowns)

/**
 * (BARU) Mengunci/membatasi dropdown Tipe Aktivitas berdasarkan tahap terakhir
 * @param {string | null} latestStage - Nama tahap terakhir (misal: "Desire"). 
 * Jika 'null', buka semua kunci.
 */
function lockActivityType(latestStage) {
    const activityTypeInput = document.getElementById('meetingType');
    if (!activityTypeInput) return;

    // 1. Jika latestStage null, buka semua kunci dan keluar
    if (latestStage === null) {
        Array.from(activityTypeInput.options).forEach(opt => opt.disabled = false);
        return;
    }

    // 2. Temukan indeks tahap terakhir
    const latestStageIndex = AIDA_PIPELINE_ORDER.indexOf(latestStage);

    // 3. Jika tahap terakhir tidak dikenal (misal: "Awareness" pertama kali),
    //    perlakukan seolah-olah tahap terakhir adalah -1 (sebelum "Awareness")
    const minIndex = (latestStageIndex === -1) ? -1 : latestStageIndex;

    let firstEnabledOption = null;

    // 4. Loop melalui semua <option> di dropdown
    Array.from(activityTypeInput.options).forEach(opt => {
        const optionStage = opt.value;
        const optionStageIndex = AIDA_PIPELINE_ORDER.indexOf(optionStage);

        // Opsi 'Lost' selalu bisa dipilih
        if (optionStage === 'Lost') {
            opt.disabled = false;
            return;
        }

        // 5. Jika tahap opsi < tahap minimum, nonaktifkan
        if (optionStageIndex < minIndex) {
            opt.disabled = true;
        } else {
            // 6. Jika tahap opsi >= tahap minimum, aktifkan
            opt.disabled = false;
            if (!firstEnabledOption) {
                firstEnabledOption = opt.value; // Catat opsi valid pertama
            }
        }
    });

    // 7. Atur nilai dropdown ke tahap valid paling awal (biasanya tahap yang sama)
    if (firstEnabledOption) {
        activityTypeInput.value = firstEnabledOption;
    }
}

    // --- LOGIKA DATA LOCAL STORAGE (MOCK) ---
    // Fungsi ini dikosongkan karena kita hanya menggunakan data live
    function getMockDealsData() { return []; } 
    
// Fungsi untuk memproses data mentah (dari API/Mock) ke format internal (allDeals)
    function processDealsData(deals) {
        if (!deals || deals.length === 0) return [];
        
        return deals.map(deal => {
             // Mapping Keys dari output Spreadsheet (Nama Kolom) ke format internal (camelCase)
             const mappedDeal = {
                 // --- MODIFIKASI PENTING UNTUK ID ---
                 // Gunakan Record_ID sebagai ID unik baris. 
                 // ID_DEAL (RFQ) tidak bisa jadi ID unik karena bisa kosong/duplikat.
                 id: deal.id || 'err_id_' + Date.now() + Math.random(), 
                 // --- AKHIR MODIFIKASI ---

                 client: deal.Nama_Klien || deal.client,
                 sales: deal.Nama_Sales || deal.sales,
                 meetingType: deal.Type_Aktivitas || deal.meetingType,
                 value: parseInt(String(deal.Nilai_Deal || deal.value).replace(/\./g, '')) || 0,
                 recurring: deal.Recurring === true || String(deal.Recurring).toUpperCase() === 'TRUE' || deal.recurring === true,
                 obstacle: deal.Hambatan || deal.obstacle,
                 meetingDate: deal.Tanggal_Meeting || deal.meetingDate,
                 notes: deal.Hasil_Meeting || deal.notes,
                 clientType: deal.Tipe_Klien || deal.clientType,
                 capability: deal.Capability || deal.capability,
                 unitInCharge: deal.Unit_in_Charge || deal.unitInCharge,
                 supportCategory: deal.Kategori_Support || deal.supportCategory,
                 supportStatus: deal.Support_Status || deal.supportStatus,
                 
                 // --- MODIFIKASI: Bawa ID_DEAL (RFQ) & Project_GUID ---
                 nomorRFQ: deal.ID_DEAL || deal.nomorRFQ, // Ini adalah Lead ID (RFQ)
                 projectGUID: deal.Project_GUID || null, // Ini adalah Kunci Gold Standard
                 // --- AKHIR MODIFIKASI ---
                 
                 namaProject: deal.Nama_Project || deal.namaProject,
                 lokasiKota: deal.Lokasi_Kota || deal.lokasiKota,
                 lokasiProvinsi: deal.Lokasi_Provinsi || deal.lokasiProvinsi,
                 clientSegment: deal.Client_Segment || deal.clientSegment || 'Enterprise'
             };

             // Buat objek Date
             if (mappedDeal.meetingDate) {
                 try {
                     const parts = mappedDeal.meetingDate.split('-');
                     // Saya tambahkan pengecekan parts[0].length === 4 untuk memastikan formatnya YYYY-MM-DD
                     if (parts.length === 3 && parts[0].length === 4) {
                         mappedDeal.meetingDateObj = new Date(parts[0], parts[1] - 1, parts[2]);
                         // Pengecekan tambahan jika tanggalnya tidak valid (misal: 2024-99-99)
                         if (isNaN(mappedDeal.meetingDateObj.getTime())) {
                            throw new Error("Tanggal tidak valid setelah di-parse");
                         }
                         mappedDeal.meetingDateObj.setHours(12, 0, 0, 0); 
                     } else { 
                        // INI BAGIAN BARU: Mencatat data yang formatnya salah
                        console.warn('DATA DIABAIKAN (Format Tanggal Salah):', {
                            client: mappedDeal.client, 
                            dateString: mappedDeal.meetingDate, 
                            leadId: mappedDeal.nomorRFQ,
                            reason: "Format harus YYYY-MM-DD"
                        });
                        throw new Error("Format tanggal salah"); 
                     }
                 } catch (dateError) {
                      // INI BAGIAN BARU: Mencatat data yang error
                      console.error('DATA DIABAIKAN (Error Parsing Tanggal):', {
                            client: mappedDeal.client, 
                            dateString: mappedDeal.meetingDate, 
                            leadId: mappedDeal.nomorRFQ,
                            error: dateError.message
                      });
                      mappedDeal.meetingDateObj = null;
                 }
             } else { 
                 // INI BAGIAN BARU: Mencatat data yang tanggalnya kosong
                 console.warn('DATA DIABAIKAN (Tanggal Kosong):', {
                     client: mappedDeal.client, 
                     leadId: mappedDeal.nomorRFQ,
                     reason: "Tanggal_Meeting kosong"
                 });
                 mappedDeal.meetingDateObj = null; 
             }
             return mappedDeal;

         }).filter(d => d.meetingDateObj !== null && !isNaN(d.meetingDateObj?.getTime())); 
    }

    // --- BARU: Kunci localStorage & Generator GUID ---
    const LOCAL_STORAGE_KEY = 'mySalesDashboardData';

    /**
     * Menghasilkan ID unik untuk project (Solusi Gold Standard)
     */
    function generateGUID() {
        return 'proj_' + Date.now() + '-' + Math.floor(Math.random() * 1000);
    }
    // --- AKHIR BARU ---


    // --- LOGIKA FETCH / POST KE GOOGLE SCRIPT (DIMODIFIKASI UNTUK LOCALSTORAGE) ---

   // --- LOGIKA FETCH / POST KE GOOGLE SCRIPT (JSONP) ---

    // --- FUNGSI HELPER BARU UNTUK JSONP ---
    function jsonpRequest(baseUrl, params) {
        return new Promise((resolve, reject) => {
            const callbackName = 'jsonp_callback_' + Math.floor(Date.now() + Math.random() * 10000);

            let queryString = `?callback=${callbackName}`;
            for (const key in params) {
                queryString += `&${key}=${encodeURIComponent(params[key])}`;
            }

            const script = document.createElement('script');
            script.src = baseUrl + queryString; 

            window[callbackName] = (data) => {
                resolve(data);
                document.head.removeChild(script);
                delete window[callbackName];
            };

            script.onerror = (err) => {
                const errorMsg = 'Gagal memuat script JSONP. Cek URL GScript, pastikan di-deploy ulang, dan pastikan akses "Anyone".';
                console.error(errorMsg, err);
                reject(new Error(errorMsg));
            }; // <-- (FIX 1) Menutup 'script.onerror'

            document.head.appendChild(script); // <-- (FIX 2) Menambahkan script ke DOM (PENTING)

        }); // <-- (FIX 3) Menutup 'new Promise'
    } // <-- (FIX 4) Menutup 'jsonpRequest'

    /* // <-- (FIX 5) Memperbaiki format komentar
     * [PERBAIKAN JSONP] Mengambil data Realisasi dari Google Apps Script
     */
    async function fetchDataFromScript() {
        console.log("MODE JSONP: Mengambil data Realisasi (action=getData)...");
        
        // (BARU) Buat parameter dinamis berdasarkan role
        let dealParams = { 
            action: 'getData',
            role: currentRole // Selalu kirim role
        };
        if (currentRole === 'sales') {
            dealParams.salesPerson = currentUser; // Kirim salesPerson jika sales
        }
        
        try {
            // (MODIFIKASI) Kirim parameter dinamis
            const deals = await jsonpRequest(GOOGLE_SCRIPT_URL, dealParams); 
            
            if (Array.isArray(deals)) {
                return processDealsData(deals);
            } else {
                throw new Error(deals.message || 'Data tidak diterima dalam format array.');
            }

        } catch (error) {
            console.error("Google Script JSONP Fetch Error:", error);
            showCustomModal("Error Koneksi Live Data", "Gagal mengambil data Realisasi (JSONP). Error: " + error.message);
            throw error; 
        }
    }

    /** * [PERBAIKAN JSONP] Mengirim data BARU (Realisasi) atau UPDATE (Support)
    */
    async function postDataToScript(payload) {
        console.log("MODE JSONP: Mengirim data ke Google Apps Script...", payload);
        let params = {}; 

        if (payload.action === 'create' && payload.data) {
            // --- Konversi ke format 'addData' GScript baru ---
            params = payload.data; 
            params.action = 'addData'; // Tambahkan parameter action

        } else if (payload.action === 'update' && payload.idToFind && payload.data.Support_Status) {
            // --- Konversi ke format 'updateSupportStatus' GScript baru ---
            params.action = 'updateSupportStatus';
            params.id = payload.idToFind; // GScript baru mengharapkan 'id'
            params.status = payload.data.Support_Status; // GScript baru mengharapkan 'status'

        } else {
            console.error("Payload tidak dikenali untuk postDataToScript JSONP:", payload);
            throw new Error("Payload tidak dikenali untuk postDataToScript JSONP.");
        }

        try {
            const result = await jsonpRequest(GOOGLE_SCRIPT_URL, params);

            if (result.status !== "sukses") {
                throw new Error(result.message || 'Terjadi error di server Apps Script.');
            }

            console.log("Google Script JSONP Post Success:", result.message);
            return result; 

        } catch (error) {
            console.error("Google Script JSONP Post Error:", error);
            showCustomModal("Error Submit Data", "Gagal menyimpan (JSONP): " + error.message);
            throw error;
        }
    }

    // --- LOGIKA UTAMA APLIKASI ---

    function init() {
        populateDropdowns();
        populateSupportDropdowns();
        populateWilayahDropdowns();
setupManagerTabListeners(); // <--- PERBAIKAN: Menambahkan ()
        
        setupTabListeners(); // <--- MODIFIKASI: Panggil listener tab

        // Periksa session storage untuk status login
        currentRole = sessionStorage.getItem('salesRole');
        currentUser = sessionStorage.getItem('salesUser');
        
        if (currentRole) {
            showDashboard();
        } else {
            showLogin();
        }
        setupEventListeners();
    }


    // Tampilkan layar login
    function showLogin() {
        sessionStorage.clear();
        currentRole = null;
        currentUser = null;
        
        // Pastikan mainContent disembunyikan dan direset
        mainContent.classList.add('hidden');
        mainContent.classList.remove('visible'); 

        loginScreen.classList.remove('hidden');
        loginScreen.style.display = 'flex'; // Pastikan login screen terlihat
        
        // --- PERBAIKAN ---
roleSelector.value = 'sales';

// Secara eksplisit TAMPILKAN dropdown sales
salesPersonSelectorContainer.classList.remove('hidden');

// Secara eksplisit SEMBUNYIKAN dropdown manager
managerSelectorContainer.classList.add('hidden');
        
        passwordInput.value = '';
        loginError.classList.add('hidden');
    }

    // Tampilkan dashboard setelah login
    async function showDashboard() {
        // HILANGKAN LOGIN SCREEN SEPENUHNYA
        loginScreen.classList.add('hidden');
        loginScreen.style.display = 'none'; 
        
        // TAMPILKAN LOADING (Sekarang di luar mainContent)
        document.getElementById('loadingIndicator').classList.remove('hidden');
        
        // --- (PERBAIKAN) AMBIL DATA SECARA PARALEL & LEBIH ROBUST ---
        
        // 1. Siapkan parameter untuk fetch data Rencana (Plans)
        let planParams = { 
            action: 'getPlans',
            role: currentRole, // (BARU) Selalu kirim role
            _timestamp: new Date().getTime() 
        };
        if (currentRole === 'sales') {
            planParams.salesPerson = currentUser;
        }

        // 2. Siapkan parameter untuk fetch data Realisasi (Deals)
        // (fetchDataFromScript sekarang sudah "smart" dan akan mengambil parameter dari global)
        
        // 3. Gunakan Promise.allSettled untuk fetch keduanya
        const results = await Promise.allSettled([
            fetchDataFromScript(), // Promise 0: allDeals (sekarang sudah "smart")
            jsonpRequest(GOOGLE_SCRIPT_URL, planParams) // Promise 1: allPlansFull
        ]);

        // 4. Proses hasil Promise 0 (allDeals / Realisasi)
        if (results[0].status === 'fulfilled') {
            allDeals = results[0].value; // value adalah processDealsData(deals)
            if (allDeals.length === 0) {
                 console.warn("Spreadsheet Realisasi (Deals) kosong.");
            }
        } else {
            // Jika fetch GAGAL
            console.error("Gagal mengambil data Realisasi (Deals):", results[0].reason);
            allDeals = []; // Pastikan kosong
            showCustomModal("Error Data Realisasi", "Gagal mengambil data Realisasi dari Google Apps Script. Error: " + results[0].reason.message);
        }

        // 5. Proses hasil Promise 1 (allPlansFull / Rencana)
        if (results[1].status === 'fulfilled') {
            allPlansFull = results[1].value;
            // State global allPlans HANYA berisi yang 'planned'
            allPlans = allPlansFull.filter(p => p.status === 'planned');
            if (allPlansFull.length === 0) {
                 console.warn("Spreadsheet Rencana (Plans) kosong.");
            }
        } else {
            // Jika fetch GAGAL
            console.error("Gagal mengambil data Rencana (Plans):", results[1].reason);
            allPlans = [];
            allPlansFull = [];
            showCustomModal("Error Data Rencana", "Gagal mengambil data Rencana dari Google Sheet. Error: " + results[1].reason.message);
        }
        // --- AKHIR PERBAIKAN FETCH DATA ---


        // TAMPILKAN MAIN CONTENT (opacity 0)
        mainContent.classList.remove('hidden');
        
        Chart.defaults.color = '#9ca3af'; 
        Chart.defaults.borderColor = '#374151'; 
        
        // Terapkan efek fade-in dengan durasi yang lebih lama (0.8s)
        setTimeout(() => {
            mainContent.classList.add('visible');
            // Sembunyikan loading indicator SETELAH fade-in dimulai
            document.getElementById('loadingIndicator').classList.add('hidden'); 
        }, 50); 
        
        // MODIFIKASI: Panggil renderer rencana
        renderPlanList();
        renderPlanSelector();
renderFollowUpLeadSelector();
populateClientDatalist();
        
        renderAppView();
    }
    
    // Atur tampilan dashboard berdasarkan peran (role)
    function renderAppView() {
        let filterOptionsHtml = '';
        
        if (currentRole === 'manager') {
            const myTeam = managerTeamMap[currentUser] || [];
            filterOptionsHtml = '<option value="all">Semua Tim Saya</option>' + myTeam.map(name => `<option value="${name}">${name}</option>`).join('');
            
            dashboardSubtitle.textContent = `Ringkasan performa untuk tim ${currentUser}.`;
            managerFilterContainer.classList.remove('hidden');
            summaryContainer.classList.remove('hidden');
            dailyActivityTrendContainer.classList.remove('hidden');
            document.getElementById('managerPlanningMetricsWrapper').classList.remove('hidden');
            
            // --- PERBAIKAN BUG 2 ---
            // (MODIFIKASI) Tampilkan tab Leads Aktif untuk Manager
            const tab3Button = document.getElementById('manager-tab-btn-3');
            if(tab3Button) tab3Button.classList.remove('hidden'); // Diubah dari .add('hidden')
            
            // Sembunyikan tab Looker (Tab 4) untuk Manager
            const tab4Button = document.getElementById('manager-tab-btn-4');
            if(tab4Button) tab4Button.classList.add('hidden');
            // --- AKHIR PERBAIKAN BUG 2 ---
                        
            // --- MODIFIKASI TAB ---
            salesTabsContainer.classList.add('hidden'); // Sembunyikan 3-tab
            document.getElementById('tab-panel-1').classList.add('hidden');
            document.getElementById('tab-panel-2').classList.add('hidden');
            document.getElementById('tab-panel-3').classList.remove('hidden');

        } else if (currentRole === 'head_sales') {
            filterOptionsHtml = '<option value="all">Semua Sales</option>' + allSales.map(name => `<option value="${name}">${name}</option>`).join('');

            dashboardSubtitle.textContent = 'Ringkasan performa seluruh tim sales.';
            managerFilterContainer.classList.remove('hidden');
            summaryContainer.classList.remove('hidden');
            dailyActivityTrendContainer.classList.remove('hidden');
            document.getElementById('managerPlanningMetricsWrapper').classList.remove('hidden');
            
            // --- PERBAIKAN BUG 1 ---
            // (MODIFIKASI) Tampilkan tab Leads Aktif (Tab 3)
            const tab3Button = document.getElementById('manager-tab-btn-3');
            if(tab3Button) tab3Button.classList.remove('hidden');
            
            // (BARU) Tampilkan juga tab Looker (Tab 4) untuk Head Sales
            const tab4Button = document.getElementById('manager-tab-btn-4');
            if(tab4Button) tab4Button.classList.remove('hidden');
            // --- AKHIR PERBAIKAN BUG 1 ---
            
            // --- MODIFIKASI TAB ---
            salesTabsContainer.classList.add('hidden'); // Sembunyikan 3-tab
            document.getElementById('tab-panel-1').classList.add('hidden');
            document.getElementById('tab-panel-2').classList.add('hidden');
            document.getElementById('tab-panel-3').classList.remove('hidden');

        } else { // Sales Person
            dashboardSubtitle.textContent = `Selamat datang kembali, ${currentUser}!`;
            salesFilter.value = currentUser; // Set filter ke diri sendiri
            managerFilterContainer.classList.add('hidden');
            summaryContainer.classList.add('hidden'); 
            dailyActivityTrendContainer.classList.add('hidden');
            
            // --- MODIFIKASI TAB ---
            salesTabsContainer.classList.remove('hidden'); // Tampilkan 3-tab
            // Atur tab default ke "Perencanaan" (Tab 1)
            document.getElementById('tab-btn-1').click();
            
            salesPersonInput.innerHTML = `<option value="${currentUser}">${currentUser}</option>`;
            salesPersonInput.value = currentUser;
            document.getElementById('meetingDate').valueAsDate = new Date();
            // Set tanggal default untuk form perencanaan
            if (document.getElementById('planDate')) {
                 document.getElementById('planDate').valueAsDate = new Date();
            }
        }
        
        salesFilter.innerHTML = filterOptionsHtml;
        
        // Atur filter tanggal default (Bulan Ini)
        const periodButton = globalPeriodFilters.querySelector('[data-period="this-month"]');
        if (periodButton) {
            globalPeriodFilters.querySelector('.active')?.classList.remove('active');
            periodButton.classList.add('active');
        }

        const today = new Date();
        currentCalendarDate = new Date(today.getFullYear(), today.getMonth(), 1);
        
        renderFilteredDashboard();
    }
    // Fungsi untuk mengambil rentang tanggal filter
    function getFilterDates() {
        const selectedPeriod = globalPeriodFilters.querySelector('.active')?.dataset.period;
        const today = new Date();
        let startDate, endDate, prevStartDate, prevEndDate;
        
        today.setHours(0, 0, 0, 0);

        if (selectedPeriod === 'this-week') {
            const firstDayOfWeek = today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1); 
            startDate = new Date(new Date(today).setDate(firstDayOfWeek));
            endDate = new Date(new Date(startDate).setDate(startDate.getDate() + 6));
            prevStartDate = new Date(new Date(startDate).setDate(startDate.getDate() - 7));
            prevEndDate = new Date(new Date(endDate).setDate(endDate.getDate() - 7));
        } else if (selectedPeriod === 'this-month') {
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            prevStartDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            prevEndDate = new Date(today.getFullYear(), today.getMonth(), 0);
        } else if (selectedPeriod === 'custom') { 
            startDate = new Date(startDateInput.value);
            endDate = new Date(endDateInput.value);
             if (!startDateInput.value || !endDateInput.value || isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                return { startDate: null, endDate: null, prevStartDate: null, prevEndDate: null }; 
            }
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(0, 0, 0, 0);
            
            const diffDays = Math.round((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24));
            prevStartDate = new Date(new Date(startDate).setDate(startDate.getDate() - diffDays - 1));
            prevEndDate = new Date(new Date(startDate).setDate(startDate.getDate() - 1));

            prevStartDate.setHours(0, 0, 0, 0);
        } else {
             return { startDate: null, endDate: null, prevStartDate: null, prevEndDate: null }; 
        }
        
        if(endDate && !isNaN(endDate)) endDate.setHours(23, 59, 59, 999);
        if(prevEndDate && !isNaN(prevEndDate)) prevEndDate.setHours(23, 59, 59, 999);

        return { startDate, endDate, prevStartDate, prevEndDate };
    }


    // Fungsi utama untuk me-render ulang dashboard berdasarkan filter
    function renderFilteredDashboard() {
        const { startDate, endDate, prevStartDate, prevEndDate } = getFilterDates();
        
        let salesToDisplay = []; 
        if (currentRole === 'manager') {
            const myTeam = managerTeamMap[currentUser] || [];
            salesToDisplay = (salesFilter.value === 'all') ? myTeam : [salesFilter.value];
        } else if (currentRole === 'head_sales') {
            salesToDisplay = (salesFilter.value === 'all') ? allSales : [salesFilter.value];
        } else { 
            salesToDisplay = [currentUser];
        }

        if (!startDate || !endDate) {
            filteredDeals = [];
            prevPeriodDeals = [];
        } else {
            filteredDeals = allDeals.filter(deal => {
                const dealDate = deal.meetingDateObj; 
                if (!dealDate || isNaN(dealDate.getTime())) return false; 
                const salesMatch = salesToDisplay.includes(deal.sales);
                return salesMatch && dealDate >= startDate && dealDate <= endDate;
            });

             prevPeriodDeals = [];
            if (prevStartDate && prevEndDate && !isNaN(prevStartDate.getTime()) && !isNaN(prevEndDate.getTime())) {
                prevPeriodDeals = allDeals.filter(deal => {
                    const dealDate = deal.meetingDateObj; 
                     if (!dealDate || isNaN(dealDate.getTime())) return false;
                    const salesMatch = salesToDisplay.includes(deal.sales);
                    return salesMatch && dealDate >= prevStartDate && dealDate <= prevEndDate;
                });
            }
        }
        
        // Hitung metrik Hibrida (PASSING salesToDisplay BARU)
        const performanceMetrics = calculateSalesPerformance(filteredDeals, salesToDisplay);

        // Panggil semua fungsi render
    updateSalesSummary(performanceMetrics); 

    // (MODIFIKASI) Selalu panggil metrik perencanaan untuk semua role
    // dan KIRIM 'salesToDisplay' agar kartunya dinamis.
    renderPlanningMetrics(salesToDisplay, currentRole);

    renderMetrics(filteredDeals, performanceMetrics); 
        
        if (currentCalendarDate instanceof Date && !isNaN(currentCalendarDate.getTime())) {
             renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth()); 
        }

        renderTopMeetingTypesChart(filteredDeals); 
        renderCapabilityChart(filteredDeals);
        renderWinRateChart(performanceMetrics); 
        renderClientSegmentProgress(filteredDeals); // NEW: RENDER PROGRESS SEGMENT
        
        supportCurrentPage = 1; // RESET Paginasi setiap kali filter global berubah
        renderSupportNeededTable(allDeals, salesToDisplay);
// (BARU) Panggil fungsi render tabel stale leads
renderStaleLeadsTable(allDeals, salesToDisplay);
// (BARU) Panggil renderer untuk tabel Leads Aktif
renderActiveLeadsTable(allDeals, salesToDisplay);
        
        if (currentRole === 'manager' || currentRole === 'head_sales') {
            renderDailyActivityTrend(filteredDeals); 
        }
    }
    
    // --- KALKULASI METRIK HIBRIDA (Diperbarui dengan salesToDisplay) ---
    const calculateSalesPerformance = (deals, salesToDisplay) => {
        const met = {
            totalMeetings: 0,
            totalRFQs: 0, wonRFQs: 0, closedRFQs: 0, totalDealValueWon: 0, rfqFromExisting: 0, 
            totalNewClients: new Set(), totalExistingClients: new Set(), 
            awarenessCount: 0, interestCount: 0, desireCount: 0, actionCount: 0, 
            totalStepsWon: 0, uniqueRFQs: new Set(), wonRFQsSet: new Set(), closedRFQsSet: new Set(),
            topCapability: 'N/A', topActivityStatus: 'N/A', avgSalesCycleDuration: 0
        };
        
        const capabilityCounts = {};
        const statusCounts = {};

        deals.forEach(deal => {
            // --- PERBAIKAN: Gunakan Project_GUID sebagai kunci unik ---
            const rfqId = deal.projectGUID || deal.id;
            const status = deal.meetingType;
            const dealValue = deal.value || 0;
            
            met.totalMeetings++;
            met.uniqueRFQs.add(rfqId);
            
            if (['Delivery', 'Payment', 'Action'].includes(status) && dealValue > 0) met.wonRFQsSet.add(rfqId);
            if (['Delivery', 'Payment', 'Action', 'Lost'].includes(status)) met.closedRFQsSet.add(rfqId);
            
            if (status === 'Awareness') met.awarenessCount++;
            else if (status === 'Interest') met.interestCount++;
            else if (status === 'Desire' || status === 'ProcessClosing') met.desireCount++;
            else if (['Action', 'Delivery', 'Payment'].includes(status)) met.actionCount++; 

            const cap = deal.capability || 'Lainnya';
            capabilityCounts[cap] = (capabilityCounts[cap] || 0) + 1;
            const currentStatus = deal.meetingType || 'Lainnya';
            statusCounts[currentStatus] = (statusCounts[currentStatus] || 0) + 1;
        });

        met.topCapability = Object.entries(capabilityCounts).sort(([, a], [, b]) => b - a)[0]?.[0] || 'N/A';
        met.topActivityStatus = Object.entries(statusCounts).sort(([, a], [, b]) => b - a)[0]?.[0] || 'N/A';

        met.totalRFQs = met.uniqueRFQs.size;
        met.wonRFQs = met.wonRFQsSet.size;
        met.closedRFQs = met.closedRFQsSet.size;

        met.winRate = met.totalRFQs > 0 ? (met.wonRFQs / met.totalRFQs) * 100 : 0;
        
        // --- LOGIKA BARU UNTUK KLIEN BARU / EXISTING (BERDASARKAN ASAL LEAD ID) ---
        met.uniqueRFQs.forEach(rfqId => {
            const rfqHistory = allDeals
                // --- PERBAIKAN: Gunakan Project_GUID sebagai kunci unik ---
                .filter(d => (d.projectGUID || d.id) === rfqId)
                .sort((a, b) => (a.meetingDateObj?.getTime() || 0) - (b.meetingDateObj?.getTime() || 0));

            if (rfqHistory.length === 0) return;
            const firstMeeting = rfqHistory[0];

            if (firstMeeting.clientType === 'new') {
                met.totalNewClients.add(firstMeeting.client);
            } else {
                met.totalExistingClients.add(firstMeeting.client);
                met.rfqFromExisting++; 
            }
        });
        // --- AKHIR LOGIKA BARU ---
        
        let totalStepsForWonRFQs = 0;
        met.wonRFQsSet.forEach(wonRfqId => {
             // --- PERBAIKAN: Gunakan Project_GUID sebagai kunci unik ---
             const steps = allDeals.filter(d => (d.projectGUID || d.id) === wonRfqId).length;
             totalStepsForWonRFQs += steps;
        });
        met.avgStepsWon = met.wonRFQs > 0 ? totalStepsForWonRFQs / met.wonRFQs : 0;
        met.rfqFromExistingRatio = met.totalRFQs > 0 ? (met.rfqFromExisting / met.totalRFQs) * 100 : 0;

        const totalMeetingsAIDA = met.awarenessCount + met.interestCount + met.desireCount + met.actionCount; 
        met.aida = {
            awareness: totalMeetingsAIDA > 0 ? (met.awarenessCount / totalMeetingsAIDA) * 100 : 0,
            interest: totalMeetingsAIDA > 0 ? (met.interestCount / totalMeetingsAIDA) * 100 : 0,
            desire: totalMeetingsAIDA > 0 ? (met.desireCount / totalMeetingsAIDA) * 100 : 0,
            action: totalMeetingsAIDA > 0 ? (met.actionCount / totalMeetingsAIDA) * 100 : 0 
        };

        // --- PERBAIKAN: calculateSalesCycle sekarang menggunakan allDeals, bukan filteredDeals ---
        const cycleData = calculateSalesCycle(allDeals, allSales); 
        let totalDuration = 0;
        let totalCycles = 0;
        
        cycleData.filter(d => salesToDisplay.includes(d.sales)).forEach(d => {
            totalDuration += d.averageDuration * d.dealCount;
            totalCycles += d.dealCount;
        });
        met.avgSalesCycleDuration = totalCycles > 0 ? Math.round(totalDuration / totalCycles) : 0;
        
        return met;
    };
    
    // Update 4 Metrik Hibrida (dan Metrik Efisiensi)
    function renderMetrics(filteredDeals, met) {
        if (!metricTotalMeetingsEl || metricTotalMeetingsEl.offsetParent === null) return; // <-- TAMBAHKAN BARIS INI

        metricTotalMeetingsEl.textContent = met.totalMeetings.toLocaleString('id-ID');
        metricNewClientsEl.textContent = met.totalNewClients.size.toLocaleString('id-ID'); 
        metricExistingClientsEl.textContent = met.totalExistingClients.size.toLocaleString('id-ID');
        metricTotalRFQsEl.textContent = met.totalRFQs.toLocaleString('id-ID');
        
        metricAvgStepsEl.textContent = met.avgStepsWon.toFixed(1);
        metricExistingRatioEl.textContent = `${met.rfqFromExistingRatio.toFixed(1)}%`; 
        avgSalesCycleDurationEl.textContent = met.avgSalesCycleDuration > 0 ? met.avgSalesCycleDuration : 'N/A';
    }


    // Update Narasi Ringkasan (Hibrida)
    const updateSalesSummary = (met) => {
        
        // --- Bagian 4: AIDA Progress Bar (FIX: Dipindahkan ke atas agar berjalan untuk SEMUA ROLE) ---
        const segments = [
            { name: 'Awareness', value: met.aida.awareness, color: 'bg-blue-500' },
            { name: 'Interest', value: met.aida.interest, color: 'bg-green-500' },
            { name: 'Desire', value: met.aida.desire, color: 'bg-yellow-500' },
            { name: 'Action', value: met.aida.action, color: 'bg-red-500' }, 
        ];

        const totalAIDA = segments.reduce((sum, s) => sum + s.value, 0);
        
        const progressBarContainer = document.getElementById('aidaProgressBar');
        if (progressBarContainer) {
            const progressBarHtml = segments.map(s => {
                const percentLabel = s.value.toFixed(1) + '%';
                const adjustedValue = totalAIDA > 0 ? (s.value / totalAIDA) * 100 : 0;
                return `<div class="progress-segment ${s.color} flex items-center justify-center text-xs font-bold text-white" style="width: ${adjustedValue.toFixed(1)}%;" title="${s.name}: ${s.value.toFixed(1)}%">${adjustedValue >= 5 ? percentLabel : ''}</div>`;
            }).join('');
            progressBarContainer.innerHTML = progressBarHtml;

            const legendHtml = segments.map(s => `
                <div class="flex flex-col">
                    <span class="text-xs text-gray-500">${s.name}</span>
                    <span class="text-base font-semibold text-white">${s.value.toFixed(1)}%</span>
                </div>
            `).join('');
            document.getElementById('aidaLegend').innerHTML = legendHtml;
        }

        // --- Bagian 3: Ringkasan Naratif (Hanya untuk Manager/Head Sales) ---
        if(currentRole === 'sales') return; // FIX: Pengecekan 'sales' dipindah ke sini
        
        const topCap = met.topCapability;
        const topStatus = met.topActivityStatus;
        const winRateStatus = met.winRate > 30 ? 'sangat efektif' : met.winRate > 15 ? 'cukup baik' : 'perlu ditingkatkan';
        const avgStepsStatus = met.avgStepsWon < 4 && met.avgStepsWon > 0 ? 'sangat efisien' : met.avgStepsWon < 6 && met.avgStepsWon > 0 ? 'efisien' : 'cenderung lambat';
        const existingRatioStatus = met.rfqFromExistingRatio > 40 ? 'tinggi, menunjukkan engagement yang kuat' : met.rfqFromExistingRatio > 20 ? 'sedang, dengan potensi cross-selling yang baik' : 'rendah, fokus utama pada akuisisi klien baru';
        
        if (summaryTextEl) {
             summaryTextEl.innerHTML = `
                Dalam periode ini, Sales Person yang terpilih (<b>${met.totalMeetings.toLocaleString('id-ID')} meeting</b> dari <b>${met.totalRFQs.toLocaleString('id-ID')} Lead ID unik</b>) menunjukkan <b>Efektivitas Kinerja</b> yang baik.
                <br><br>
                Fokus utama Sales Person adalah pada Capability <b>${topCap}</b> dan aktivitas yang paling sering dilakukan adalah tahap <b>${topStatus}</b> dalam pipeline.
                <br><br>
                <b>Win Rate</b> (berdasarkan Total Lead ID Unik) berada di <b>${met.winRate.toFixed(1)}%</b>, yang berarti ${winRateStatus} dalam mengubah peluang menjadi kemenangan.
                <br>
                Untuk <b>Efisiensi Siklus Penjualan</b>, rata-rata deal yang dimenangkan hanya membutuhkan <b>${met.avgStepsWon.toFixed(1)} meeting</b> untuk bergerak dari awal hingga closing, menunjukkan proses yang ${avgStepsStatus}.
                <br>
                Sementara itu, <b>Rasio Lead ID Existing</b> (indikator Engagement) mencapai <b>${met.rfqFromExistingRatio.toFixed(1)}%</b>. Rasio ini ${existingRatioStatus}.
            `;
        }
    };
    
    // Render Grafik Tren Aktivitas Harian (Dasboard Hibrida)
    const renderDailyActivityTrend = (deals) => {
        const ctx = document.getElementById('dailyActivityChart')?.getContext('2d');
        if (!ctx) return;
        if (ctx.canvas.offsetParent === null) return; // <-- TAMBAHKAN BARIS INI
        
        const { startDate, endDate } = getFilterDates();
        if (!startDate || !endDate) return; 
        
        startDate.setHours(0, 0, 0, 0);
        endDate.setHours(0, 0, 0, 0);

        const activityMap = {}; 
        
        // (PERBAIKAN 1) Typo 'allDeSals' -> 'allDeals'
        deals.forEach(deal => {
            const dateKey = formatDate(deal.meetingDateObj);
            
            activityMap[dateKey] = activityMap[dateKey] || { newRfqNewClient: 0, newRfqExistingClient: 0, existingRfq: 0 };
            
            // --- PERBAIKAN: Gunakan Project_GUID sebagai kunci unik ---
            const dealHistory = allDeals.filter(d => (d.projectGUID || d.id) === (deal.projectGUID || deal.id)).sort((a, b) => (a.meetingDateObj?.getTime() || 0) - (b.meetingDateObj?.getTime() || 0));
            
            const isFirstMeeting = dealHistory.length > 0 && dealHistory[0].meetingDate === deal.meetingDate;

            if (isFirstMeeting) {
                if (deal.clientType === 'new') {
                    activityMap[dateKey].newRfqNewClient++; 
                } else {
                    activityMap[dateKey].newRfqExistingClient++; 
                }
            } else {
                activityMap[dateKey].existingRfq++; 
            }
        });
        
        // --- (DIHAPUS) BLOK KODE DI BAWAH INI ADALAH DUPLIKAT YANG SALAH TEMPAT ---
        /*
        ...
        allPlans = allPlansFull.filter(p => p.status === 'planned');
        */
        // --- AKHIR BLOK YANG DIHAPUS ---

        // (PERBAIKAN 2) Logika chart 'config' yang hilang, ditambahkan kembali
        const labels = [];
        const dataNewRfqNew = [];
        const dataNewRfqExisting = [];
        const dataExistingRfq = [];

        // Loop from startDate to endDate
        let currentDate = new Date(startDate);
        while (currentDate <= endDate) {
            const dateKey = formatDate(currentDate);
            labels.push(dateKey);
            
            const dayData = activityMap[dateKey] || { newRfqNewClient: 0, newRfqExistingClient: 0, existingRfq: 0 };
            dataNewRfqNew.push(dayData.newRfqNewClient);
            dataNewRfqExisting.push(dayData.newRfqExistingClient);
            dataExistingRfq.push(dayData.existingRfq);
            
            currentDate.setDate(currentDate.getDate() + 1);
        }

        const config = {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'New Lead (New Client)', data: dataNewRfqNew, backgroundColor: '#ef4444' }, // Red
                    { label: 'New Lead (Existing Client)', data: dataNewRfqExisting, backgroundColor: '#f59e0b' }, // Amber
                    { label: 'Follow Up (Existing Lead)', data: dataExistingRfq, backgroundColor: '#3b82f6' } // Blue
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { stacked: true, type: 'time', time: { unit: 'day', tooltipFormat: 'dd MMM yyyy' }, grid: { display: false } },
                    y: { stacked: true, ticks: { precision: 0 }, grid: { color: '#374151' } }
                },
                plugins: { legend: { position: 'bottom', labels: { color: '#a1a1aa' } } }
            }
        };

            if (charts.dailyActivity) charts.dailyActivity.destroy();
            charts.dailyActivity = new Chart(ctx, config);
        // (PERBAIKAN 3) Kurung kurawal '}' ekstra dihapus dari sini
    } // <-- (PERBAIKAN) Menambahkan '}' yang hilang untuk menutup renderDailyActivityTrend

    // (PERBAIKAN) MEMBUAT FUNGSI renderTopMeetingTypesChart YANG HILANG
    function renderTopMeetingTypesChart(deals) {
        const ctx = document.getElementById('topMeetingTypesChart')?.getContext('2d');
        if (!ctx) return;
        if (ctx.canvas.offsetParent === null) return; 

        const typeCounts = deals.reduce((acc, deal) => {
            const type = deal.meetingType || 'Lainnya';
            acc[type] = (acc[type] || 0) + 1;
            return acc;
        }, {});

        // Urutkan dari yang terbesar
        const sortedTypes = Object.entries(typeCounts).sort(([, a], [, b]) => b - a);
        const labels = sortedTypes.map(entry => entry[0]);
        const data = sortedTypes.map(entry => entry[1]);

        if (charts.topTypes) charts.topTypes.destroy();
        charts.topTypes = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Jumlah',
                    data: data,
                    backgroundColor: [
                        '#3b82f6', '#10b981', '#f59e0b', '#ef4444', 
                        '#8b5cf6', '#a3a3a3' // Warna fallback jika ada lebih banyak
                    ],
                    borderColor: '#1f2937', 
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { color: '#a1a1aa' } } }
            }
        });
    }


    // Render Grafik Fokus Capability (Doughnut)
   function renderCapabilityChart(deals) {
        const ctx = document.getElementById('capabilityChart')?.getContext('2d');
        if (!ctx) return;
        if (ctx.canvas.offsetParent === null) return; // <-- TAMBAHKAN BARIS INI

        const capabilityCounts = deals.reduce((acc, deal) => {
            const cap = deal.capability || 'Belum Ditentukan';
            acc[cap] = (acc[cap] || 0) + 1;
            return acc;
        }, {});

        const labels = Object.keys(capabilityCounts);
        const data = Object.values(capabilityCounts);

        if (charts.capability) charts.capability.destroy();
        charts.capability = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Fokus Capability',
                    data: data,
                    backgroundColor: [
                        '#10b981', '#3b82f6', '#f59e0b', '#ef4444' 
                    ],
                    borderColor: '#1f2937',
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { color: '#a1a1aa' } } }
            }
        });
    }
    
    // NEW: Render Grafik Segment Klien (Progress Bar)
    function renderClientSegmentProgress(deals) {
    const progressBarContainer = document.getElementById('clientSegmentProgressBar');
    if (!progressBarContainer || progressBarContainer.offsetParent === null) return;

    const segmentCounts = deals.reduce((acc, deal) => {
            const segment = deal.clientSegment || 'Enterprise'; 
            acc[segment] = (acc[segment] || 0) + 1;
            return acc;
        }, {});
        
        const totalMeetings = deals.length;

        const segmentsData = [
            { name: 'Enterprise', count: segmentCounts['Enterprise'] || 0, color: 'bg-purple-500' },
            { name: 'Government', count: segmentCounts['Government'] || 0, color: 'bg-orange-500' },
            { name: 'Education', count: segmentCounts['Education'] || 0, color: 'bg-cyan-500' },
        ];
        
        const segments = segmentsData.map(s => {
            const percentage = totalMeetings > 0 ? (s.count / totalMeetings) * 100 : 0;
            const percentLabel = percentage.toFixed(1) + '%';
            const adjustedValue = totalMeetings > 0 ? (s.count / totalMeetings) * 100 : 0;
            
            return {
                ...s,
                percentage: percentage,
                adjustedValue: adjustedValue,
                percentLabel: percentLabel
            };
        });

        if (progressBarContainer) {
            const progressBarHtml = segments.map(s => {
                return `<div class="progress-segment ${s.color} flex items-center justify-center text-xs font-bold text-white" style="width: ${s.adjustedValue.toFixed(1)}%;" title="${s.name}: ${s.count} Meetings">${s.adjustedValue >= 5 ? s.percentLabel : ''}</div>`;
            }).join('');
            progressBarContainer.innerHTML = progressBarHtml;

            const legendHtml = segments.map(s => `
                <div class="flex flex-col">
                    <span class="text-xs text-gray-500">${s.name}</span>
                    <span class="text-base font-semibold text-white">${s.percentage.toFixed(1)}%</span>
                </div>
            `).join('');
            document.getElementById('clientSegmentLegend').innerHTML = legendHtml;
        }
    }


    // Render Grafik Win Rate (Doughnut dengan Label Tengah)
    const renderWinRateChart = (met) => {
         const ctx = document.getElementById('winRateChart')?.getContext('2d');
         if (!ctx) return;
         if (ctx.canvas.offsetParent === null) return; // <-- TAMBAHKAN BARIS INI
         
         const totalRFQs = met.totalRFQs;
         const wonRFQs = met.wonRFQs;
         const lostClosedRFQs = met.closedRFQsSet.size - met.wonRFQs;
         
         const wonPercentage = totalRFQs > 0 ? (wonRFQs / totalRFQs) * 100 : 0;
         const lostClosedPercentage = totalRFQs > 0 ? (lostClosedRFQs / totalRFQs) * 100 : 0;


         if (charts.winRate) charts.winRate.destroy();
         charts.winRate = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Won Lead ID', 'Lost/Closed Lead ID', 'Pending/In Process'],
                datasets: [{
                    data: [met.wonRFQs, lostClosedRFQs, (totalRFQs - met.wonRFQs - lostClosedRFQs)], 
                    backgroundColor: ['#10b981', '#ef4444', '#f59e0b'], // Won, Lost, Pending/In Process
                    borderColor: '#1f2937',
                    borderWidth: 3
                }]
            },
            options: {
                 responsive: true,
                 maintainAspectRatio: false,
                 cutout: '70%',
                 plugins: { legend: { position: 'bottom', labels: { color: '#a1a1aa' } } }
            }
         });
         
         const chartArea = ctx.canvas.parentNode;
         let winRateLabel = chartArea.querySelector('#winRateCenterLabel');
         if (!winRateLabel) {
             winRateLabel = document.createElement('div');
             winRateLabel.id = 'winRateCenterLabel';
             winRateLabel.className = 'absolute inset-0 flex flex-col items-center justify-center pointer-events-none';
             chartArea.style.position = 'relative'; 
             chartArea.appendChild(winRateLabel);
         }
         winRateLabel.innerHTML = `
             <span class="text-3xl font-bold text-white">${wonPercentage.toFixed(1)}%</span>
             <span class="text-sm text-gray-400 mt-1">Win Rate</span>
         `;
    }
    
    // Render Tabel Support Needed (Tampilan Hibrida)
    function renderSupportNeededTable(allDeals, salesToDisplay) {
const tableBody = document.getElementById('supportTableBody');
if (!tableBody || tableBody.offsetParent === null) return;

let dealsToProcess = allDeals;
        if(currentRole === 'sales'){
            dealsToProcess = allDeals.filter(d => d.sales === currentUser);
        } else if (salesFilter.value !== 'all') {
            dealsToProcess = allDeals.filter(d => d.sales === salesFilter.value);
        } else if (currentRole === 'manager') {
            const myTeam = managerTeamMap[currentUser] || [];
            dealsToProcess = allDeals.filter(d => myTeam.includes(d.sales));
        } else if (currentRole === 'head_sales' && salesFilter.value === 'all') {
             dealsToProcess = allDeals; // Semua deal
        }


        const latestDealsMap = new Map();
        dealsToProcess.forEach(deal => {
            // --- PERBAIKAN: Gunakan Project_GUID sebagai kunci unik ---
            const key = deal.projectGUID || deal.id;
            const dealDate = deal.meetingDateObj?.getTime();

            if (dealDate && (!latestDealsMap.has(key) || dealDate > (latestDealsMap.get(key).meetingDateObj?.getTime() || 0))) {
                latestDealsMap.set(key, deal);
            }
        });

        currentSupportDeals = Array.from(latestDealsMap.values()).filter(deal => 
            deal.supportStatus === 'On Process' 
        ).sort((a, b) => b.value - a.value); 

        displayPaginatedSupportTable();
    }

    // --- FUNGSI BARU: Untuk Menampilkan Tabel Support + Paginasi ---
    function displayPaginatedSupportTable() {
        const tableBody = document.getElementById('supportTableBody');
        const paginationContainer = document.getElementById('supportPaginationContainer');
        if (!tableBody || !paginationContainer) return; // Guard clause

        let tableHTML = '';
        let paginationHTML = '';

        const totalDeals = currentSupportDeals.length;
        const totalPages = Math.ceil(totalDeals / SUPPORT_ROWS_PER_PAGE);

        if (supportCurrentPage > totalPages && totalPages > 0) {
            supportCurrentPage = totalPages;
        } else if (totalPages === 0) {
            supportCurrentPage = 1;
        }
        
        const startIndex = (supportCurrentPage - 1) * SUPPORT_ROWS_PER_PAGE;
        const endIndex = startIndex + SUPPORT_ROWS_PER_PAGE;
        const paginatedDeals = currentSupportDeals.slice(startIndex, endIndex);

        if (totalDeals === 0) {
            tableHTML = `
                <tr><td colspan="6" class="text-center text-gray-500 py-4">Tidak ada Lead ID aktif yang membutuhkan support.</td></tr>
            `;
        } else {
            tableHTML = paginatedDeals.map(deal => {
                let statusColor;
                if (deal.supportStatus === 'On Process') {
                    statusColor = 'bg-yellow-800 text-yellow-300';
                } else if (deal.supportStatus === 'Solved') {
                    statusColor = 'bg-emerald-800 text-emerald-300';
                } else {
                    statusColor = 'bg-gray-700 text-gray-400';
                }

                return `
                    <tr>
                        <td class="whitespace-nowrap font-medium text-white">${deal.client}</td>
                        <td class="whitespace-nowrap">${deal.namaProject || 'N/A'}</td>
                        <td class="whitespace-nowrap font-semibold">${formatIDR(deal.value)}</td>
                        <td class="whitespace-nowrap">${deal.unitInCharge || 'N/A'}</td>
                        <td class="whitespace-nowrap">${deal.supportCategory || 'N/A'}</td>
                        <td class="whitespace-nowrap">
                            ${currentRole === 'sales' ? `
                                <select class="support-status-select w-full rounded-md border-gray-600 bg-gray-700 p-2 text-xs text-white" data-id="${deal.id}">
                                    <option value="On Process" ${deal.supportStatus === 'On Process' ? 'selected' : ''}>On Process</option>
                                    <option value="Solved" ${deal.supportStatus === 'Solved' ? 'selected' : ''}>Solved</option>
                                </select>`
                            : `<span class="px-3 py-1 text-xs rounded-full ${statusColor}">${deal.supportStatus}</span>`}
                        </td>
                    </tr>
                `
            }).join('');
        }
        tableBody.innerHTML = tableHTML;

        if (totalDeals > SUPPORT_ROWS_PER_PAGE) {
            paginationHTML = `
                <span class="text-sm text-gray-400">
                    Total: ${totalDeals} item
                </span>
                <div class="flex items-center gap-2">
                    <button id="supportPrevBtn" class="px-3 py-1.5 rounded-md bg-gray-700 text-gray-300 hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium" ${supportCurrentPage === 1 ? 'disabled' : ''}>
                        <i class="h-4 w-4" data-lucide="chevron-left" style="pointer-events: none;"></i>
                    </button>
                    <span class="text-sm text-gray-400 font-medium">
                        Hal ${supportCurrentPage} dari ${totalPages}
                    </span>
                    <button id="supportNextBtn" class="px-3 py-1.5 rounded-md bg-gray-700 text-gray-300 hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium" ${supportCurrentPage >= totalPages ? 'disabled' : ''}>
                        <i class="h-4 w-4" data-lucide="chevron-right" style="pointer-events: none;"></i>
                    </button>
                </div>
            `;
            paginationContainer.innerHTML = paginationHTML;
            lucide.createIcons();
        } else if (totalDeals > 0) {
             paginationHTML = `
                <span class="text-sm text-gray-400">
                    Total: ${totalDeals} item
                </span>
            `;
            paginationContainer.innerHTML = paginationHTML;
        } else {
            paginationContainer.innerHTML = ''; 
        }
    }
    
// (BARU) Render Tabel Stale Leads (> 7 hari)
    function renderStaleLeadsTable(allDeals, salesToDisplay) {
        const tableBody = document.getElementById('staleLeadsTableBody');
        // Pastikan tabel ada di DOM (hanya ada di dashboard Manager/Head Sales)
        if (!tableBody || tableBody.offsetParent === null) return; 

        const today = new Date();
        const closedStatus = ['Action', 'Delivery', 'Payment', 'Lost'];
        const leadGroups = new Map();

        // 1. Kelompokkan semua deal berdasarkan projectGUID
        allDeals.forEach(deal => {
            if (!deal.projectGUID) return; // Abaikan jika tidak ada GUID
            if (!leadGroups.has(deal.projectGUID)) {
                leadGroups.set(deal.projectGUID, []);
            }
            leadGroups.get(deal.projectGUID).push(deal);
        });

        const staleLeads = [];

        // 2. Analisa setiap grup lead
        leadGroups.forEach((deals, guid) => {
            // Urutkan untuk menemukan deal terbaru
            deals.sort((a, b) => b.meetingDateObj.getTime() - a.meetingDateObj.getTime());
            const latestDeal = deals[0];

            // 3. Cek apakah sales person-nya relevan dengan filter
            if (!salesToDisplay.includes(latestDeal.sales)) {
                return; // Abaikan lead ini, bukan milik sales yg difilter
            }

            // 4. Cek apakah lead sudah "closed"
            if (closedStatus.includes(latestDeal.meetingType)) {
                return; // Abaikan lead yang sudah closed
            }

            // 5. Hitung selisih hari
            const lastActivityDate = latestDeal.meetingDateObj;
            const diffTime = Math.abs(today - lastActivityDate);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            // 6. Jika lebih dari 7 hari, tambahkan ke daftar
            if (diffDays > 7) {
                staleLeads.push({
                    client: latestDeal.client,
                    namaProject: latestDeal.namaProject,
                    value: latestDeal.value,
                    status: latestDeal.meetingType,
                    daysSinceLastActivity: diffDays
                });
            }
        });

        // 7. Urutkan berdasarkan hari terlama
        staleLeads.sort((a, b) => b.daysSinceLastActivity - a.daysSinceLastActivity);

        // 8. Render ke tabel
        if (staleLeads.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-4">Tidak ada Lead ID yang tidak aktif lebih dari 7 hari.</td></tr>`;
            return;
        }

        tableBody.innerHTML = staleLeads.map(lead => `
            <tr>
                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-white">${lead.client}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300">${lead.namaProject || 'N/A'}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300">${formatIDR(lead.value)}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300">
                    <span class="status-label status-${lead.status.replace(/\s/g, '')}">${lead.status}</span>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-red-400 text-center">${lead.daysSinceLastActivity} hari</td>
            </tr>
        `).join('');
    }
// (BARU) Render Tabel Active Leads (Tab 3 Manager)
    // (MODIFIKASI TOTAL) Render Tabel Active Leads dengan Tab Status & Paginasi
    function renderActiveLeadsTable(allDeals, salesToDisplay) {
        const tableBody = document.getElementById('activeLeadsTableBody');
        const paginationContainer = document.getElementById('activeLeadsPaginationContainer');
        const tableTitle = document.getElementById('activeLeadsTableTitle');

        // Pastikan tabel ada di DOM dan sedang ditampilkan
        if (!tableBody || !paginationContainer || tableBody.offsetParent === null) return;

        // Update Judul Tabel
        const statusTitleMap = {
            'Awareness': 'Awareness',
            'Interest': 'Interest',
            'Desire': 'Desire / Process Closing',
            'Action': 'Action / Delivery / Payment'
        };
        tableTitle.textContent = `Daftar Leads: ${statusTitleMap[currentActiveLeadStatusTab] || 'Awareness'}`;

        const latestDealsMap = new Map();
        const closedStatus = 'Lost'; // Sesuai permintaan Anda

        // 1. Temukan data (status, amount) terakhir untuk setiap project (GUID)
        allDeals.forEach(deal => {
            if (!deal.projectGUID) return; // Hanya proses yang punya GUID

            const existing = latestDealsMap.get(deal.projectGUID);
            if (!existing || deal.meetingDateObj.getTime() > existing.meetingDateObj.getTime()) {
                latestDealsMap.set(deal.projectGUID, deal);
            }
        });

        // 2. Ubah Map ke Array dan filter berdasarkan sales DAN status 'Lost'
        const activeLeads = Array.from(latestDealsMap.values())
            .filter(deal => {
                const salesMatch = salesToDisplay.includes(deal.sales);
                const statusMatch = deal.meetingType !== closedStatus;
                return salesMatch && statusMatch;
            });

        // 3. (BARU) Filter berdasarkan Sub-Tab Status yang aktif
        const filteredByStatusLeads = activeLeads.filter(lead => {
            const status = lead.meetingType;
            if (currentActiveLeadStatusTab === 'Awareness') return status === 'Awareness';
            if (currentActiveLeadStatusTab === 'Interest') return status === 'Interest';
            if (currentActiveLeadStatusTab === 'Desire') return status === 'Desire' || status === 'ProcessClosing';
            if (currentActiveLeadStatusTab === 'Action') return status === 'Action' || status === 'Delivery' || status === 'Payment';
            return false; // Default case
        }).sort((a, b) => { // Urutkan A-Z berdasarkan Sales, lalu Klien
            if (a.sales < b.sales) return -1;
            if (a.sales > b.sales) return 1;
            if (a.client < b.client) return -1;
            if (a.client > b.client) return 1;
            return 0;
        });

        // 4. (BARU) Logika Paginasi
        const totalLeads = filteredByStatusLeads.length;
        const totalPages = Math.ceil(totalLeads / ACTIVE_LEADS_PER_PAGE);

        // Perbaiki halaman saat ini jika filter berubah
        if (activeLeadsCurrentPage > totalPages && totalPages > 0) {
            activeLeadsCurrentPage = totalPages;
        } else if (totalPages === 0) {
            activeLeadsCurrentPage = 1;
        }

        const startIndex = (activeLeadsCurrentPage - 1) * ACTIVE_LEADS_PER_PAGE;
        const endIndex = startIndex + ACTIVE_LEADS_PER_PAGE;
        const paginatedLeads = filteredByStatusLeads.slice(startIndex, endIndex);

        // 5. Render ke tabel
        if (paginatedLeads.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 py-4">Tidak ada leads untuk status ini.</td></tr>`;
        } else {
            tableBody.innerHTML = paginatedLeads.map(lead => `
                <tr>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-300">${lead.sales}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-white">${lead.client}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300">${lead.clientSegment || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300">${lead.namaProject || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300">
                        <span class="status-label status-${lead.meetingType.replace(/\s/g, '')}">${lead.meetingType}</span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-white">${formatIDR(lead.value)}</td>
                </tr>
            `).join('');
        }

        // 6. (BARU) Render Paginasi
        let paginationHTML = '';
        if (totalLeads > ACTIVE_LEADS_PER_PAGE) {
            paginationHTML = `
                <span class="text-sm text-gray-400">
                    Total: ${totalLeads} item
                </span>
                <div class="flex items-center gap-2">
                    <button id="activeLeadsPrevBtn" class="px-3 py-1.5 rounded-md bg-gray-700 text-gray-300 hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium" ${activeLeadsCurrentPage === 1 ? 'disabled' : ''}>
                        <i class="h-4 w-4" data-lucide="chevron-left" style="pointer-events: none;"></i>
                    </button>
                    <span class="text-sm text-gray-400 font-medium">
                        Hal ${activeLeadsCurrentPage} dari ${totalPages}
                    </span>
                    <button id="activeLeadsNextBtn" class="px-3 py-1.5 rounded-md bg-gray-700 text-gray-300 hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium" ${activeLeadsCurrentPage >= totalPages ? 'disabled' : ''}>
                        <i class="h-4 w-4" data-lucide="chevron-right" style="pointer-events: none;"></i>
                    </button>
                </div>
            `;
        } else if (totalLeads > 0) {
            paginationHTML = `<span class="text-sm text-gray-400">Total: ${totalLeads} item</span>`;
        }
        
        paginationContainer.innerHTML = paginationHTML;
        lucide.createIcons();
    }
    // --- KALENDER (Diperbarui dengan logika Hibrida) ---
    const getMonthNames = () => ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    const getDayNames = () => ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
    
    // Modal Hibrida: Detail Aktivitas Tanggal
    const showCalendarModal = (dateString) => {
        const modal = calendarModal;
        const modalTitle = document.getElementById('calendarModalTitle');
        const modalContent = calendarModalContent;
        
        let date = null;
        try {
            const parts = dateString.split('-');
            date = new Date(parts[0], parts[1] - 1, parts[2]);
            date.setHours(0, 0, 0, 0);
        } catch (e) { return; }

        let salesToDisplay = [currentUser];
        if (currentRole === 'manager') {
            salesToDisplay = (salesFilter.value === 'all') ? (managerTeamMap[currentUser] || []) : [salesFilter.value];
        } else if (currentRole === 'head_sales') {
            salesToDisplay = (salesFilter.value === 'all') ? allSales : [salesFilter.value];
        }

        const dealsOnThisDay = allDeals.filter(deal => {
            const salesMatch = salesToDisplay.includes(deal.sales);
            let dealDateNormalized = null;
            if (deal.meetingDateObj instanceof Date && !isNaN(deal.meetingDateObj)) {
                dealDateNormalized = new Date(deal.meetingDateObj);
                dealDateNormalized.setHours(0,0,0,0);
            }
            return salesMatch && dealDateNormalized && dealDateNormalized.getTime() === date.getTime();
        }).sort((a, b) => (a.client || '').localeCompare(b.client || ''));
// (BARU) Ambil data RENCANA untuk tanggal ini
const plansOnThisDay = allPlans.filter(plan => {
    const salesMatch = salesToDisplay.includes(plan.salesPerson);
    let planDateNormalized = null;
     try {
         const parts = plan.plan_date.split('-');
        planDateNormalized = new Date(parts[0], parts[1] - 1, parts[2]);
        planDateNormalized.setHours(0,0,0,0);
     } catch(e) {}
    return salesMatch && planDateNormalized && planDateNormalized.getTime() === date.getTime();
}).sort((a, b) => (a.clientName || '').localeCompare(b.clientName || ''));

        modalTitle.textContent = `Aktivitas Tanggal ${date.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}`;

        let contentHTML = '';
        if (dealsOnThisDay.length === 0 && plansOnThisDay.length === 0) {
    contentHTML = '<p class="text-gray-400">Tidak ada aktivitas atau rencana terdaftar pada tanggal ini.</p>';
} else {

    // (BARU) Render Rencana (Style Biru Outline)
    if (plansOnThisDay.length > 0) {
        contentHTML += '<h4 class="text-base font-semibold text-blue-300 mb-2">Rencana Aktivitas</h4>';
        contentHTML += plansOnThisDay.map(plan => {
            return `
            <div class="bg-gray-700 p-3 rounded-lg border-l-4 border-blue-400 shadow-md mb-3">
                <p class="text-lg font-semibold text-white">${plan.clientName} (${plan.salesPerson})</p>
                <p class="text-sm text-gray-300">
                    <span class="font-medium text-blue-300">Tipe:</span> ${plan.activityType}
                </p>
                <p class="text-sm text-gray-400">Tujuan: ${plan.objective || 'N/A'}</p>
                <p class="mt-2 text-sm text-white bg-gray-600 p-2 rounded">${plan.notes || 'Tidak ada catatan.'}</p>
            </div>
        `
        }).join('');
    }

    // (MODIFIKASI) Render Realisasi (Style Hijau Solid)
    if (dealsOnThisDay.length > 0) {
        contentHTML += '<h4 class="text-base font-semibold text-green-300 mb-2 mt-4">Aktivitas Terealisasi</h4>';
        contentHTML += dealsOnThisDay.map(deal => {
            const statusClass = `status-${deal.meetingType.replace(/\s/g, '')}`;
            return `
            <div class="bg-gray-700 p-4 rounded-lg border-l-4 border-green-500 shadow-md mb-3">
                <p class="text-lg font-semibold text-white">${deal.client} (${deal.sales})</p>
                <p class="text-sm text-gray-300">
                    <span class="font-medium text-green-300">Lead ID:</span> ${deal.nomorRFQ || 'N/A'} 
                    <span class="ml-4 font-medium text-green-300">Status:</span> 
                    <span class="status-label ${statusClass}">${deal.meetingType}</span>
                </p>
                <p class="text-sm text-gray-400">Project: ${deal.namaProject || 'N/A'}</p>
                <p class="text-xs text-gray-500 mt-2">Amount: ${formatIDR(deal.value)} | Segmen: ${deal.clientSegment}</p>
                <p class="mt-2 text-sm text-white bg-gray-600 p-2 rounded">${deal.notes || 'Tidak ada catatan.'}</p>
            </div>
        `
        }).join('');
    }
}
        modalContent.innerHTML = contentHTML;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        lucide.createIcons();
    };
    // (BARU) Mengambil SEMUA rencana (bukan hanya yang 'planned')
  

  // (BARU) Menghitung dan merender metrik di Tab 1
  function renderPlanningMetrics(salesToDisplay, role) {
// (BARU) Tentukan awalan ID berdasarkan role
    let idPrefix = "";
    if (role === 'manager' || role === 'head_sales') {
        idPrefix = "mgr-";
    }

    // --- Kartu 1: Total Aktivitas Terjadwal (dari data Rencana) ---
    // (BARU) Filter data rencana berdasarkan sales person yang sedang dilihat
// (Gunakan array 'salesToDisplay' yang baru saja kita kirim)
const relevantPlans = allPlansFull.filter(p => salesToDisplay.includes(p.salesPerson));

// (MODIFIKASI) Gunakan 'relevantPlans' alih-alih 'allPlansFull'
const plansSelesai = relevantPlans.filter(p => p.status === 'realized').length;
const plansMenunggu = relevantPlans.filter(p => p.status === 'planned').length;
    const plansTotal = plansSelesai + plansMenunggu;
   
    document.getElementById(idPrefix + 'metricRencanaTotal').textContent = plansTotal;
    document.getElementById(idPrefix + 'metricRencanaSelesai').textContent = plansSelesai;
    document.getElementById(idPrefix + 'metricRencanaMenunggu').textContent = plansMenunggu;
   
    // --- Kartu 2: Rata-rata Realisasi Harian (dari data Realisasi/filteredDeals) ---
    const { startDate, endDate } = getFilterDates();
    const avgRealisasiEl = document.getElementById(idPrefix + 'metricAvgRealisasi');
    const selisihWrapperEl = document.getElementById('metricSelisihWrapper'); // ID ini tidak duplikat, biarkan
    const selisihHarianEl = document.getElementById(idPrefix + 'metricSelisihHarian');
   
    if (!startDate || !endDate || !avgRealisasiEl) {
      // Jika filter tanggal tidak valid, sembunyikan kartu
      if (avgRealisasiEl) avgRealisasiEl.closest('.bg-gray-800').classList.add('hidden');
      return;
    }
   
    avgRealisasiEl.closest('.bg-gray-800').classList.remove('hidden');

    const diffTime = Math.abs(endDate - startDate);
    // +1 untuk menyertakan hari awal
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 
   
    // Kita gunakan 'filteredDeals' (data realisasi) yang sudah difilter
    const totalAktivitas = filteredDeals.length;
    const avgAktivitas = (totalAktivitas / diffDays) || 0;
    const targetHarian = 8; // Sesuai screenshot
   
    avgRealisasiEl.textContent = avgAktivitas.toFixed(1);
    document.getElementById(idPrefix + 'metricTargetHarian').textContent = targetHarian;
    const selisih = targetHarian - avgAktivitas;
   
    if (selisih <= 0) {
      // Target tercapai
      selisihHarianEl.textContent = `Target Tercapai! (${selisih.toFixed(1)})`;
      selisihHarianEl.classList.remove('text-red-400');
      selisihHarianEl.classList.add('text-green-400');
    } else {
      // Target belum tercapai
      selisihHarianEl.textContent = `Perlu +${selisih.toFixed(1)} Aktivitas/Hari`;
      selisihHarianEl.classList.add('text-red-400');
      selisihHarianEl.classList.remove('text-green-400');
    }
   
  }
    // Modal Hibrida: Tombol Tutup
    calendarModalCloseButton.addEventListener('click', () => {
        calendarModal.classList.add('hidden');
        calendarModal.classList.remove('flex');
    });

    // --- MODIFIKASI: HAPUS renderCalendarEvent ---
    // (Diganti dengan 2 fungsi di bawah)
    
    // (BARU) Style untuk Realisasi (Solid)
    const renderRealizedEvent = (deal) => {
         const clientName = deal.client ? deal.client.substring(0, 10) : 'N/A';
         const dateString = formatDate(deal.meetingDateObj);
         return `
            <div class="calendar-event-realized" onclick="window.showCalendarModal('${dateString}')" title="${deal.client} - ${deal.meetingType}"> 
                ${clientName}... (${deal.meetingType})
            </div>
         `;
    }
    
    // (BARU) Style untuk Rencana (Outline)
    const renderPlannedEvent = (plan) => {
     const clientName = plan.clientName ?
 plan.clientName.substring(0, 10) : 'N/A';
     // (MODIFIKASI) Ambil dateString (YYYY-MM-DD) dari rencana
     const dateString = plan.plan_date;
     
     // (MODIFIKASI) Tambahkan onclick="window.showCalendarModal(...)"
     return `
        <div class="calendar-event-planned" onclick="window.showCalendarModal('${dateString}')" title="${plan.clientName} (Rencana: ${plan.activityType})"> 
            ${clientName}... (${plan.activityType})
        </div>
     `;
 }
    
    // Ekspos fungsi ke scope global agar dapat dipanggil dari HTML inline onclick
    window.showCalendarModal = showCalendarModal;
    
    // (MODIFIKASI TOTAL) Render Kalender (Logic Hibrida)
    function renderCalendar(year, month) {
if (!currentMonthYearEl || currentMonthYearEl.offsetParent === null) return;

    const monthNames = getMonthNames();
        currentMonthYearEl.textContent = `${monthNames[month]} ${year}`;

        const firstDayOfMonthObj = new Date(year, month, 1);
        const firstDay = firstDayOfMonthObj.getDay(); 
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();
        today.setHours(0,0,0,0); 

        let calendarHTML = `<div class="calendar-grid">`;
        let date = 1;
        const dayOffset = (firstDay === 0) ? 6 : firstDay - 1; 

        // Filter sales person (tetap sama)
        let salesToDisplay = [currentUser];
        if (currentRole === 'manager') {
            salesToDisplay = (salesFilter.value === 'all') ? (managerTeamMap[currentUser] || []) : [salesFilter.value];
        } else if (currentRole === 'head_sales') {
            salesToDisplay = (salesFilter.value === 'all') ? allSales : [salesFilter.value];
        }

        for (let i = 0; i < 6; i++) { 
            for (let j = 0; j < 7; j++) {
                if (i === 0 && j < dayOffset) {
                    calendarHTML += `<div class="calendar-cell other-month"></div>`; 
                } else if (date > daysInMonth) {
                     calendarHTML += `<div class="calendar-cell other-month"></div>`; 
                } else {
                    const currentDate = new Date(year, month, date);
                    currentDate.setHours(0,0,0,0); 
                    const isToday = currentDate.getTime() === today.getTime();
                    
                    const dateString = formatDate(currentDate.toISOString());
                    
                    // --- LOGIKA BARU: AMBIL 2 TIPE DATA ---
                    
                    // 1. Ambil Realisasi (dari allDeals)
                    const dealsOnThisDay = allDeals.filter(deal => {
                         const salesMatch = salesToDisplay.includes(deal.sales);
                         let dealDateNormalized = null;
                         if (deal.meetingDateObj instanceof Date && !isNaN(deal.meetingDateObj)) {
                            dealDateNormalized = new Date(deal.meetingDateObj);
                            dealDateNormalized.setHours(0,0,0,0);
                         }
                         return salesMatch && dealDateNormalized && dealDateNormalized.getTime() === currentDate.getTime();
                    });
                    
                    // 2. Ambil Rencana (dari allPlans)
    // (MODIFIKASI) Tampilkan rencana untuk SEMUA role, tapi filter berdasarkan
    // sales person yang sedang dilihat di dashboard
    let plansOnThisDay = allPlans.filter(plan => {
        // (BARU) Pastikan sales person-nya cocok dengan filter global
        const salesMatch = salesToDisplay.includes(plan.salesPerson);
        let planDateNormalized = null;
         try {
             const parts = plan.plan_date.split('-'); // YYYY-MM-DD
            planDateNormalized = new Date(parts[0], parts[1] - 1, parts[2]);
            planDateNormalized.setHours(0, 0, 0, 0);
         } catch(e) {}
         
        // (MODIFIKASI) Tambahkan 'salesMatch'
        return salesMatch && planDateNormalized && planDateNormalized.getTime() === currentDate.getTime();
     });
                    // --- AKHIR LOGIKA BARU ---

                    let eventsHTML = '';
                    const maxEventsToShow = 2;
                    
                    // Render Rencana Dulu (Style Outline)
                    plansOnThisDay.forEach(plan => {
                        eventsHTML += renderPlannedEvent(plan);
                    });
                    
                    // Render Realisasi (Style Solid)
                    const dealsToShow = dealsOnThisDay.slice(0, maxEventsToShow - plansOnThisDay.length);
                    eventsHTML += dealsToShow.map(deal => renderRealizedEvent(deal)).join('');
                    
                    // Hitung tombol "Lainnya"
                    const totalItems = dealsOnThisDay.length + plansOnThisDay.length;
                    const itemsShown = dealsToShow.length + plansOnThisDay.length;
                    
                    // Tombol 'lainnya' hanya memicu modal Realisasi (deals)
                    if (dealsOnThisDay.length > dealsToShow.length || (dealsOnThisDay.length > 0 && plansOnThisDay.length > 0 && totalItems > maxEventsToShow)) {
                         const remainingCount = dealsOnThisDay.length - dealsToShow.length;
                         const planCount = plansOnThisDay.length;
                         let remainingText = `+${remainingCount} realisasi`;
                         if (remainingCount === 0 && planCount > 0) {
                             remainingText = `+${planCount} rencana`;
                         } else if (remainingCount > 0 && planCount > 0) {
                             remainingText = `+${remainingCount} realisasi, ${planCount} rencana`;
                         }
                         
                         eventsHTML += `<div class="calendar-others" onclick="window.showCalendarModal('${dateString}')" title="Lihat detail">${remainingText}</div>`;
                    }


                    calendarHTML += `
                        <div class="calendar-cell ${isToday ? 'today' : ''}">
                            <div class="calendar-date">${date}</div>
                            ${eventsHTML}
                        </div>`;
                    date++;
                }
            }
             if (date > daysInMonth) { break; }
        }
        calendarHTML += `</div>`;

        const oldGrid = calendarContainer.querySelector('.calendar-grid');
        if (oldGrid) oldGrid.remove();
        calendarContainer.insertAdjacentHTML('beforeend', calendarHTML); 
        lucide.createIcons();
    }
    
    // [MODIFIKASI] Kalkulasi Rata-rata Durasi Sales Cycle (Grouping by Project_GUID)
    // --- PERBAIKAN: Menghapus duplikasi kode ---
    function calculateSalesCycle(allDeals, salesToDisplay) { 
        const relevantDeals = allDeals.filter(d => d.sales && salesToDisplay.includes(d.sales));
        
        const projectGroups = relevantDeals.reduce((acc, deal) => {
            const projectGUID = deal.projectGUID; 
            if (!projectGUID) return acc; 

            acc[projectGUID] = acc[projectGUID] || [];
            acc[projectGUID].push(deal);
            return acc;
        }, {});
        
        const salesData = {};
        
        for(const guid in projectGroups){
            const projectDeals = projectGroups[guid].sort((a,b) => (a.meetingDateObj?.getTime() || 0) - (b.meetingDateObj?.getTime() || 0));
            
            const awarenessDeal = projectDeals.find(d => d.meetingType === 'Awareness');
            const actionDeal = projectDeals.find(d => d.meetingType === 'Action');

            if(awarenessDeal && actionDeal && awarenessDeal.meetingDateObj && actionDeal.meetingDateObj){
                const awarenessDate = awarenessDeal.meetingDateObj;
                const actionDate = actionDeal.meetingDateObj;
                if (isNaN(awarenessDate.getTime()) || isNaN(actionDate.getTime())) continue; 

                const duration = Math.ceil((actionDate - awarenessDate) / (1000 * 60 * 60 * 24));
                const closingSales = actionDeal.sales;
                
                if(duration >= 0){
                    salesData[closingSales] = salesData[closingSales] || { totalDuration: 0, dealCount: 0 };
                    salesData[closingSales].totalDuration += duration;
                    salesData[closingSales].dealCount++;
                }
            }
        }
        
        const result = [];
        for(const salesName in salesData){
            const data = salesData[salesName];
            if (data.dealCount > 0) {
                 result.push({
                    sales: salesName,
                    dealCount: data.dealCount,
                    averageDuration: Math.round(data.totalDuration / data.dealCount)
                 });
             }
        }
        return result;
    }

    // --- Event Listeners ---
    function setupEventListeners() {
        

        // Filter Periode (Minggu, Bulan, Custom)
        globalPeriodFilters.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                globalPeriodFilters.querySelector('.active')?.classList.remove('active');
                e.target.classList.add('active');
                customDateContainer.classList.toggle('hidden', e.target.dataset.period !== 'custom');
                if (e.target.dataset.period !== 'custom') {
                     const { startDate } = getFilterDates();
                     if (startDate && !isNaN(startDate.getTime())) {
                        currentCalendarDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
                     }
                     renderFilteredDashboard();
                }
            }
        });
// (BARU) Listener untuk Sub-Tab Status Leads Aktif
        const leadsStatusTabsContainer = document.getElementById('leadsStatusTabsContainer');
        if (leadsStatusTabsContainer) {
            leadsStatusTabsContainer.addEventListener('click', (e) => {
                const clickedTab = e.target.closest('.leads-status-tab');
                if (!clickedTab) return;

                const newStatus = clickedTab.dataset.status;
                if (newStatus === currentActiveLeadStatusTab) return; // Jangan lakukan apa-apa jika tab yang sama diklik

                // Update state global
                currentActiveLeadStatusTab = newStatus;
                activeLeadsCurrentPage = 1; // Reset halaman ke 1

                // Update UI Tab
                leadsStatusTabsContainer.querySelectorAll('.leads-status-tab').forEach(tab => {
                    tab.classList.remove('active-tab');
                    tab.classList.add('inactive-tab');
                });
                clickedTab.classList.add('active-tab');
                clickedTab.classList.remove('inactive-tab');

                // Render ulang dashboard untuk menerapkan filter status dan paginasi baru
                renderFilteredDashboard();
            });
        }
// (MODIFIKASI) Listener untuk dropdown Tujuan Meeting (Tab 1)
    const planObjectiveSelect = document.getElementById('planObjective');
    const planFollowUpContainer = document.getElementById('planFollowUpContainer');

    if (planObjectiveSelect) {
        planObjectiveSelect.addEventListener('change', (e) => {
            if (e.target.value === 'Follow up inisiasi atau Leads') {
                planFollowUpContainer.classList.remove('hidden');
                document.getElementById('planFollowUpLead').required = true;
                // (BARIS BARU) Ambil nama klien yang sudah diketik
                const currentClientName = document.getElementById('planClientName').value;
                // (BARIS BARU) Panggil renderer dinamis saat dropdown diubah
                renderFollowUpLeadSelector(currentClientName);
            } else {
                planFollowUpContainer.classList.add('hidden');
                document.getElementById('planFollowUpLead').required = false;
            }
        });
    }
// (BARU) Listener untuk "Nama Klien" di Tab 1, untuk memfilter dropdown follow-up
    const planClientNameInput = document.getElementById('planClientName');
    if (planClientNameInput) {
        planClientNameInput.addEventListener('blur', (e) => { // 'blur' = event saat user klik keluar dari field
            const clientName = e.target.value;
            const objective = document.getElementById('planObjective').value;

            // Jika tujuannya follow up, update dropdown
            if (objective === 'Follow up inisiasi atau Leads') {
                renderFollowUpLeadSelector(clientName);
            }
        });
    }
        // --- (GANTI TOTAL BLOK DI BAWAH INI) ---
// (MODIFIKASI TOTAL) Listener untuk dropdown Realisasi Rencana (Tab 2)
if (planSelector) {
    planSelector.addEventListener('change', (e) => {
        const selectedPlanId = e.target.value;

        // 1. Ambil semua elemen DOM form yang akan di-lock
        const clientNameInput = document.getElementById('clientName');
        const nomorRFQInput = document.getElementById('nomorRFQ');
        const namaProjectInput = document.getElementById('namaProject');
        const meetingDateInput = document.getElementById('meetingDate');
        const provinsiInput = document.getElementById('lokasiProvinsi');
        const kotaInput = document.getElementById('lokasiKota');
        const segmentInput = document.getElementById('clientSegment');

        // 2. Reset dan Buka Kunci SEMUA field
        clientNameInput.value = '';
        nomorRFQInput.value = '';
        namaProjectInput.value = '';
        
        // Buka kunci (enable) semua field
        meetingDateInput.disabled = false;
        provinsiInput.disabled = false;
        kotaInput.disabled = false;
        segmentInput.disabled = false;

        // Reset dropdown lokasi & AIDA
        provinsiInput.value = "";
        segmentInput.value = "Enterprise"; // default
        kotaInput.innerHTML = '<option value="">-- Pilih Provinsi Dulu --</option>';
        lockActivityType(null); // 'null' akan membuka semua kunci AIDA

        // 3. Jika user memilih "Tidak, ini aktivitas baru"
        if (!selectedPlanId) {
            // Set tanggal ke hari ini (karena baru)
            document.getElementById('meetingDate').valueAsDate = new Date();
            return; // Selesai, form kosong dan tidak dikunci
        }

        // --- Mulai Logika Penguncian ---

        // 4. Temukan Rencana yang dipilih dari state global
        const selectedPlan = allPlans.find(p => p.plan_id === selectedPlanId);
        if (!selectedPlan) return;

        // 5. Isi Nama Klien (dari Rencana)
        clientNameInput.value = selectedPlan.clientName || '';

        // 6. (PERMINTAAN 1) Isi dan Kunci Tanggal Meeting (dari Rencana)
        meetingDateInput.value = selectedPlan.plan_date;
        meetingDateInput.disabled = true;

        // 7. Cek apakah rencana ini adalah follow-up dari deal (project) yang sudah ada
        let followUpGUID = null;
        if (selectedPlan.followUpTarget && selectedPlan.followUpTarget.startsWith('deal_')) {
            followUpGUID = selectedPlan.followUpTarget.replace('deal_', '');
        }

        // 8. Logika Inti: Tergantung ini follow-up ATAU aktivitas pertama
        if (followUpGUID) {
            // --- INI ADALAH FOLLOW-UP (Sudah ada data realisasi sebelumnya) ---

            // Cari deal terkait TERBARU di allDeals menggunakan GUID
            const projectDeals = allDeals
                .filter(d => (d.projectGUID || d.id) === followUpGUID)
                .sort((a,b) => b.meetingDateObj?.getTime() - a.meetingDateObj?.getTime());

            if (projectDeals.length > 0) {
                const latestDeal = projectDeals[0];

                // Isi Lead ID dan Nama Project
                nomorRFQInput.value = latestDeal.nomorRFQ || '';
                namaProjectInput.value = latestDeal.namaProject || '';

                // (PERMINTAAN 2) Isi dan Kunci Lokasi & Segmen
                if (latestDeal.lokasiProvinsi) {
                    provinsiInput.value = latestDeal.lokasiProvinsi;
                    provinsiInput.disabled = true;

                    // (PENTING) Isi manual dropdown kota berdasarkan provinsi
                    const cities = allWilayah[latestDeal.lokasiProvinsi] || [];
                    kotaInput.innerHTML = cities
                        .map(kota => `<option value="${kota}">${kota}</option>`)
                        .join('');
                    
                    if (latestDeal.lokasiKota) {
                        kotaInput.value = latestDeal.lokasiKota;
                    }
                    kotaInput.disabled = true;
                }
                if (latestDeal.clientSegment) {
                    segmentInput.value = latestDeal.clientSegment;
                    segmentInput.disabled = true;
                }

                // (PERMINTAAN 3) Kunci Tipe Aktivitas (AIDA)
                // Panggil helper, kirim tahap terakhir (misal: "Desire")
                lockActivityType(latestDeal.meetingType);
            }
        
        } else {
            // --- INI ADALAH AKTIVITAS PERTAMA (Rencana baru, belum ada realisasi) ---
            
            // (PERMINTAAN 3) Kunci Tipe Aktivitas HANYA ke "Awareness"
            lockActivityType(null); // Buka semua dulu
            Array.from(document.getElementById('meetingType').options).forEach(opt => {
                // Nonaktifkan semua KECUALI "Awareness"
                if (opt.value !== 'Awareness') {
                    opt.disabled = true;
                }
            });
            document.getElementById('meetingType').value = 'Awareness';
        }
    });
}
// --- (BATAS AKHIR KODE BARU) ---
        // Listener untuk filter tanggal custom dan filter sales
        [startDateInput, endDateInput, salesFilter].forEach(el => el.addEventListener('change',() => {
             const { startDate } = getFilterDates();
             if (startDate && !isNaN(startDate.getTime())) {
                currentCalendarDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
             }
             renderFilteredDashboard();
        }));
        
        // Tombol navigasi kalender
        prevMonthBtn.addEventListener('click', () => {
             if (currentCalendarDate instanceof Date && !isNaN(currentCalendarDate.getTime())) {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            }
        });
        nextMonthBtn.addEventListener('click', () => {
             if (currentCalendarDate instanceof Date && !isNaN(currentCalendarDate.getTime())) {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            }
        });
        
        // Logika dropdown login
        // --- PERBAIKAN ---
roleSelector.addEventListener('change', () => {
    const role = roleSelector.value;

    if (role === 'sales') {
        // Tampilkan sales, sembunyikan manager
        salesPersonSelectorContainer.classList.remove('hidden');
        managerSelectorContainer.classList.add('hidden');
    } else if (role === 'manager') {
        // Sembunyikan sales, tampilkan manager
        salesPersonSelectorContainer.classList.add('hidden');
        managerSelectorContainer.classList.remove('hidden');
    } else { // Ini untuk 'head_sales'
        // Sembunyikan keduanya
        salesPersonSelectorContainer.classList.add('hidden');
        managerSelectorContainer.classList.add('hidden');
    }
});

        // Tombol Login
        // ---- SALIN DAN TEMPEL KODE BARU INI ----
loginBtn.addEventListener('click', () => { 
    const role = roleSelector.value;
    const password = passwordInput.value;
    
    let user; // Variabel untuk NAMA BERSIH yang akan disimpan (cth: 'Head Sales')
    let credentialKey; // Variabel untuk KUNCI password (cth: 'head_sales')
    let expectedPassword;

    if (role === 'sales') {
        user = salesPersonSelector.value;
        credentialKey = user; // Untuk sales, nama dan kunci sama
        
    } else if (role === 'manager') {
        user = managerSelector.value;
        credentialKey = user; // Untuk manager, nama dan kunci sama
        
    } else if (role === 'head_sales') {
        user = 'Head Sales'; // NAMA BERSIH (H besar) untuk disimpan ke sesi
        credentialKey = 'head_sales'; // KUNCI (h kecil) untuk cek password
    }
    
    // Ambil password menggunakan KUNCI yang benar
    expectedPassword = userCredentials[credentialKey];

    // Lakukan pengecekan
    if (password === expectedPassword) {
        sessionStorage.setItem('salesRole', role);
        sessionStorage.setItem('salesUser', user); // Menyimpan NAMA BERSIH ('Head Sales')
        currentRole = role;
        currentUser = user;
        showDashboard();
    } else {
        loginError.classList.remove('hidden');
        passwordInput.value = '';
    }
});
// ---- BATAS AKHIR KODE BARU ----
        passwordInput.addEventListener('input', () => loginError.classList.add('hidden'));
        logoutBtn.addEventListener('click', showLogin);

        // Form: Tampilkan/sembunyikan 'Recurring' dan 'Obstacle'
        meetingTypeSelect.addEventListener('change',e=>{
            const selectedType = e.target.value;
            recurringOption.classList.toggle('hidden', !['Action', 'Delivery', 'Payment'].includes(selectedType));
            obstacleSection.classList.toggle('hidden', selectedType !== 'Lost');
        });
        
        // --- (BARU) Listener untuk Form Perencanaan (Tab 1) ---
        planForm.addEventListener('submit', async (e) => {
            // FIX: Mencegah reload halaman yang menyebabkan logout
            e.preventDefault(); 

            const saveBtn = document.getElementById('savePlanBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = 'Menyimpan...';

            // Ambil semua data dari form
            const planData = {
                action: 'addPlan', // Aksi untuk Google Apps Script
                salesPerson: currentUser,
                // --- PERBAIKAN: 'date' diubah menjadi 'plan_date' agar sesuai GSheet ---
                plan_date: document.getElementById('planDate').value,
                // --- AKHIR PERBAIKAN ---
                clientName: document.getElementById('planClientName').value,
                activityType: document.getElementById('planActivityType').value,
                objective: document.getElementById('planObjective').value,
                followUpTarget: document.getElementById('planFollowUpLead').value || '', // Kirim ID deal/plan jika ada
                notes: document.getElementById('planNotes').value,
                status: 'planned' // Status default saat dibuat
            };

            // Validasi sederhana
            if (!planData.plan_date || !planData.clientName) { // <--- PERBAIKAN: 'date' diubah menjadi 'plan_date'
                showCustomModal("Error", "Tanggal dan Nama Klien wajib diisi.");
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i data-lucide="plus" class="h-5 w-5 mr-2"></i> Tambah ke Rencana';
                lucide.createIcons();
                return;
            }

            try {
                // Kirim data menggunakan jsonpRequest
                const result = await jsonpRequest(GOOGLE_SCRIPT_URL, planData);
                
                if (result.status !== 'sukses') {
                    throw new Error(result.message || 'Gagal menyimpan di server');
                }

                // --- Jika Sukses ---
                planSuccessMessage.textContent = 'Rencana berhasil disimpan!';
                planSuccessMessage.classList.remove('hidden');
                setTimeout(() => planSuccessMessage.classList.add('hidden'), 3000);

                // Reset form (tapi pertahankan tanggal yang dipilih)
                const keptDate = planData.plan_date; // <--- PERBAIKAN: 'date' diubah menjadi 'plan_date'
                planForm.reset();
                document.getElementById('planDate').value = keptDate;
                document.getElementById('planFollowUpContainer').classList.add('hidden');

                // Muat ulang data rencana dari server
                let params = { 
                    action: 'getPlans', 
                    role: currentRole,
                    salesPerson: currentUser,
                    // (BARU) Cache-buster untuk memaksa data baru
                    _timestamp: new Date().getTime()
                };
                allPlansFull = await jsonpRequest(GOOGLE_SCRIPT_URL, params);
                
                // --- (HAPUS) DEBUGGING DIHAPUS (DIKOMENTARI) ---
                console.log("Data Rencana (LENGKAP) yang baru diambil (SETELAH ADD):", allPlansFull);
                // alert("Alert 1 (ADD): Jumlah data (allPlansFull) yang diambil: " + allPlansFull.length);
                // --- AKHIR DEBUGGING ---

                allPlans = allPlansFull.filter(p => p.status === 'planned');
                
                // --- (HAPUS) DEBUGGING 2 DIHAPUS (DIKOMENTARI) ---
                console.log("Data Rencana (SETELAH FILTER 'planned') (SETELAH ADD):", allPlans);
                // alert("Alert 2 (ADD): Jumlah data (allPlans) SETELAH filter: " + allPlans.length);
                // --- AKHIR DEBUGGING 2 ---
// Render ulang UI yang bergantung pada 'allPlans'
renderPlanList(); // Update tabel di Tab 1
renderPlanSelector(); // Update dropdown di Tab 2
renderFollowUpLeadSelector(); // Update dropdown follow-up di Tab 1
populateClientDatalist(); // Update auto-complete klien

// (PERBAIKAN) Panggil HANYA metrik Tab 1, BUKAN seluruh dashboard
let salesToDisplay = [currentUser];
renderPlanningMetrics(salesToDisplay, currentRole);

            } catch (error) {
                showCustomModal("Error Simpan Rencana", "Gagal menyimpan: " + error.message);
            
            } finally {
                // Kembalikan tombol ke status normal
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i data-lucide="plus" class="h-5 w-5 mr-2"></i> Tambah ke Rencana';
                lucide.createIcons({ nodes: [document.getElementById('savePlanBtn')] });
            }
        });

        // --- (PERBAIKAN FINAL) Listener untuk Hapus/Batal Rencana (Tab 1) ---
        planListContainer.addEventListener('click', async (e) => {
            const deleteButton = e.target.closest('.delete-plan-btn');
            if (deleteButton) {
                // Ambil ID dari GSheet (sekarang plan_id)
                const planId = deleteButton.dataset.planId; 
                
                // Menggunakan Modal Konfirmasi Kustom
                showCustomConfirmModal("Konfirmasi Hapus", "Anda yakin ingin MEMBATALKAN rencana ini? (Status akan diubah menjadi 'cancelled')", async () => {
                    // Ini adalah callback 'onConfirm'
                    try {
                        // Kirim update status ke GAS
                        const result = await jsonpRequest(GOOGLE_SCRIPT_URL, {
                            action: 'updatePlanStatus',
                            id: planId, // GScript mencari 'id'
                            status: 'cancelled' // GScript mencari 'status'
                        });

                        if (result.status !== 'sukses') {
                            throw new Error(result.message);
                        }

                        // Jika sukses, muat ulang data rencana
                        let params = { 
                            action: 'getPlans',
                            role: currentRole, 
                            salesPerson: currentUser,
                            // (BARU) Cache-buster untuk memaksa data baru
                            _timestamp: new Date().getTime()
                        };
                        allPlansFull = await jsonpRequest(GOOGLE_SCRIPT_URL, params);
                        allPlans = allPlansFull.filter(p => p.status === 'planned');

                       // Render ulang UI (CARA YANG BENAR)
                        renderPlanList();
                        renderPlanSelector();
                        renderFollowUpLeadSelector();
                        populateClientDatalist();

                        // (MODIFIKASI) Panggil HANYA renderPlanningMetrics
                        // Ini akan me-refresh kartu metrik di Tab 1 tanpa beralih tab.
                        let salesToDisplay = [currentUser];
                        
                        // Panggil fungsi spesifik untuk metrik Tab 1
                        renderPlanningMetrics(salesToDisplay, currentRole);
                        
                        // --- PANGGILAN renderCalendar() SUDAH DIHAPUS DARI SINI ---
                        
                        showCustomModal("Sukses", "Rencana telah dibatalkan."); // Modal notifikasi standar

                    } catch (error) {
                        showCustomModal("Error", "Gagal membatalkan rencana: " + error.message);
                    }
                });
            }
        });
        // --- (PERBAIKAN) LISTENER UNTUK SUBMIT REALISASI (TAB 2) YANG HILANG ---
        activityForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitButton = document.getElementById('submitBtn');
            submitButton.disabled = true;
            submitButton.innerHTML = 'Menyimpan...';

            const selectedPlanId = document.getElementById('planSelector').value;
            let projectGUID = null;
            let selectedPlan = null;

            // 1. Cek apakah ini realisasi dari rencana
            if (selectedPlanId) {
                selectedPlan = allPlans.find(p => p.plan_id === selectedPlanId);
                // 2. Ambil Project_GUID jika rencana ini adalah follow-up
                if (selectedPlan && selectedPlan.followUpTarget && selectedPlan.followUpTarget.startsWith('deal_')) {
                    projectGUID = selectedPlan.followUpTarget.replace('deal_', '');
                }
            }

            // 3. Jika bukan dari rencana follow-up, buat GUID baru
            if (!projectGUID) {
                projectGUID = generateGUID(); // Asumsikan ini project/lead baru
            }

            // 4. Kumpulkan semua data dari form
            const dealData = {
                action: 'addData', // Sesuai dengan GScript
                Nama_Klien: document.getElementById('clientName').value,
                Tanggal_Meeting: document.getElementById('meetingDate').value,
                Lokasi_Provinsi: document.getElementById('lokasiProvinsi').value,
                Lokasi_Kota: document.getElementById('lokasiKota').value,
                Client_Segment: document.getElementById('clientSegment').value,
                Nama_Sales: document.getElementById('salesPerson').value,
                Tipe_Klien: document.querySelector('input[name="clientType"]:checked').value,
                ID_DEAL: document.getElementById('nomorRFQ').value,
                Nama_Project: document.getElementById('namaProject').value,
                Hasil_Meeting: document.getElementById('meetingNotes').value,
                Type_Aktivitas: document.getElementById('meetingType').value,
                Capability: document.getElementById('capability').value,
                Nilai_Deal: document.getElementById('dealValue').value.replace(/\./g, ''), // Hapus titik
                Unit_in_Charge: document.getElementById('unitInCharge').value,
                Kategori_Support: document.getElementById('supportCategory').value,
                Support_Status: (document.getElementById('unitInCharge').value !== 'Tidak perlu support') ? 'On Process' : 'N/A',
                Recurring: document.getElementById('isRecurring')?.checked || false,
                Hambatan: (document.getElementById('meetingType').value === 'Lost') 
          ? document.getElementById('salesObstacle')?.value 
          : '',
                Project_GUID: projectGUID // Kunci terpenting
            };

            try {
                // 5. Kirim data realisasi ke GScript
                const createResult = await jsonpRequest(GOOGLE_SCRIPT_URL, dealData);
                if (createResult.status !== 'sukses') {
                    throw new Error(createResult.message || 'Gagal menyimpan realisasi');
                }

                // 6. Jika ini dari rencana, update status rencana tsb
                if (selectedPlanId) {
                    await jsonpRequest(GOOGLE_SCRIPT_URL, {
                        action: 'updatePlanStatus',
                        id: selectedPlanId,
                        status: 'realized'
                    });
                }

                // 7. Muat ulang SEMUA data (Realisasi & Rencana)
                allDeals = await fetchDataFromScript();
                
                let planParams = { 
                    action: 'getPlans',
                    role: currentRole, 
                    salesPerson: currentUser,
                    _timestamp: new Date().getTime()
                };
                allPlansFull = await jsonpRequest(GOOGLE_SCRIPT_URL, planParams);
                allPlans = allPlansFull.filter(p => p.status === 'planned');

// Render ulang UI yang bergantung pada 'allPlans'
renderPlanList(); // Update tabel di Tab 1 (rencana akan hilang)
renderPlanSelector(); // Update dropdown di Tab 2 (rencana akan hilang)
renderFollowUpLeadSelector(); // Update dropdown follow-up di Tab 1
populateClientDatalist(); // Update auto-complete klien

                // 8. Reset form dan tampilkan pesan sukses
                document.getElementById('successMessage').textContent = 'Aktivitas realisasi berhasil disimpan!';
                document.getElementById('successMessage').classList.remove('hidden');
                setTimeout(() => document.getElementById('successMessage').classList.add('hidden'), 4000);
                
                activityForm.reset();
                document.getElementById('meetingDate').valueAsDate = new Date(); // Set tanggal hari ini
                document.getElementById('salesPerson').value = currentUser; // Set sales

                
                // Render ulang dashboard utama (termasuk kalender & semua grafik)
                renderFilteredDashboard(); 

            } catch (error) {
                document.getElementById('errorMessage').textContent = 'Gagal menyimpan: ' + error.message;
                document.getElementById('errorMessage').classList.remove('hidden');
                setTimeout(() => document.getElementById('errorMessage').classList.add('hidden'), 4000);
            
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = 'Simpan';
                lucide.createIcons();
            }
        });
        // --- Listener Baru untuk Paginasi Support (Delegasi Event) ---
       // --- Listener Baru untuk Paginasi Support (Delegasi Event) ---
        mainContent.addEventListener('click', (e) => {
            const supportPrevBtn = e.target.closest('#supportPrevBtn');
            const supportNextBtn = e.target.closest('#supportNextBtn');
            const activeLeadsPrevBtn = e.target.closest('#activeLeadsPrevBtn');
            const activeLeadsNextBtn = e.target.closest('#activeLeadsNextBtn');

            if (supportPrevBtn && !supportPrevBtn.disabled) {
                supportCurrentPage--;
                displayPaginatedSupportTable(); // Hanya render ulang tabel support
            } else if (supportNextBtn && !supportNextBtn.disabled) {
                supportCurrentPage++;
                displayPaginatedSupportTable(); // Hanya render ulang tabel support
            
            // (BARU) Logika untuk paginasi Leads Aktif
            } else if (activeLeadsPrevBtn && !activeLeadsPrevBtn.disabled) {
                activeLeadsCurrentPage--;
                renderFilteredDashboard(); // Render ulang seluruh dashboard (cara aman)
            } else if (activeLeadsNextBtn && !activeLeadsNextBtn.disabled) {
                activeLeadsCurrentPage++;
                renderFilteredDashboard(); // Render ulang seluruh dashboard (cara aman)
            }
        });

        // Listener untuk tabel support (saat Sales mengubah status)
        document.getElementById('supportTableBody').addEventListener('change', async (e) => {
            if (e.target.classList.contains('support-status-select') && currentRole === 'sales') {
                const selectEl = e.target;
                const dealId = selectEl.dataset.id; // Ini adalah Record_ID (deal.id)
                const newStatus = selectEl.value;

                const dealIndex = allDeals.findIndex(d => d.id == dealId);
                if (dealIndex === -1) return;
                
                const originalStatus = allDeals[dealIndex].supportStatus;
                allDeals[dealIndex].supportStatus = newStatus; 
                renderFilteredDashboard(); // Optimistic UI update

                try {
                    // Kirim update ke Apps Script
                    // Kita mengirim 'idToFind' sebagai Record_ID (deal.id)
                    await postDataToScript({ action: 'update', idToFind: dealId, data: { Support_Status: newStatus } });
                    showCustomModal("Sukses", "Status Support berhasil diupdate.");

                } catch (error) {
                    // Rollback jika Gagal
                    allDeals[dealIndex].supportStatus = originalStatus;
                    renderFilteredDashboard();
                    showCustomModal("Error", "Gagal mengupdate status: " + error.message);
                }
            }

        });
    }
    
    // Mulai aplikasi
    init();
    lucide.createIcons();
});
</script>
</body>
</html>
